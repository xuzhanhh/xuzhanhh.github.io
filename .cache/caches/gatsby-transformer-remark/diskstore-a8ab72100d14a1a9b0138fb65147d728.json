{"expireTime":9007200807631129000,"key":"transformer-remark-markdown-ast-b3ef6a40033c4bde18b66149acd4dbcd-gatsby-remark-imagesgatsby-remark-responsive-iframegatsby-remark-prismjsgatsby-remark-copy-linked-filesgatsby-remark-smartypants-","val":{"type":"root","children":[{"type":"paragraph","children":[{"type":"text","value":"Demo:","position":{"start":{"line":2,"column":1,"offset":1},"end":{"line":2,"column":6,"offset":6},"indent":[]}}],"position":{"start":{"line":2,"column":1,"offset":1},"end":{"line":2,"column":6,"offset":6},"indent":[]}},{"type":"paragraph","children":[{"type":"link","title":null,"url":"https://stackblitz.com/edit/react-jwqn64","children":[{"type":"text","value":"https://stackblitz.com/edit/react-jwqn64","position":{"start":{"line":4,"column":1,"offset":8},"end":{"line":4,"column":41,"offset":48},"indent":[]}}],"position":{"start":{"line":4,"column":1,"offset":8},"end":{"line":4,"column":41,"offset":48},"indent":[]}}],"position":{"start":{"line":4,"column":1,"offset":8},"end":{"line":4,"column":41,"offset":48},"indent":[]}},{"type":"html","lang":"jsx","value":"<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">ClickCounter</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">React<span class=\"token punctuation\">.</span>Component</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>count<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>handleClick <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>handleClick<span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token function\">handleClick</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>count<span class=\"token punctuation\">:</span> state<span class=\"token punctuation\">.</span>count <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token function\">componentDidUpdate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n    <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span> <span class=\"token attr-name\">key</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>1<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>handleClick<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">Update counter</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>button</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">,</span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>span</span> <span class=\"token attr-name\">key</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>2<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>count<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>span</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","position":{"start":{"line":6,"column":1,"offset":50},"end":{"line":29,"column":4,"offset":582},"indent":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"当我们点击button时，我们可以看到","position":{"start":{"line":31,"column":1,"offset":584},"end":{"line":31,"column":20,"offset":603},"indent":[]}},{"type":"link","title":null,"url":"https://github.com/facebook/react/blob/cbbc2b6c4d0d8519145560bd8183ecde55168b12/packages/react-reconciler/src/ReactFiberCompleteWork.js#L532","children":[{"type":"strong","children":[{"type":"text","value":"completeWork","position":{"start":{"line":31,"column":23,"offset":606},"end":{"line":31,"column":35,"offset":618},"indent":[]}}],"position":{"start":{"line":31,"column":21,"offset":604},"end":{"line":31,"column":37,"offset":620},"indent":[]}}],"position":{"start":{"line":31,"column":20,"offset":603},"end":{"line":31,"column":180,"offset":763},"indent":[]}},{"type":"text","value":"：","position":{"start":{"line":31,"column":180,"offset":763},"end":{"line":31,"column":181,"offset":764},"indent":[]}}],"position":{"start":{"line":31,"column":1,"offset":584},"end":{"line":31,"column":181,"offset":764},"indent":[]}},{"type":"list","ordered":false,"start":null,"loose":false,"children":[{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"更新","position":{"start":{"line":33,"column":3,"offset":768},"end":{"line":33,"column":5,"offset":770},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">ClickCounter</code>","position":{"start":{"line":33,"column":5,"offset":770},"end":{"line":33,"column":19,"offset":784},"indent":[]}},{"type":"text","value":"中的count state","position":{"start":{"line":33,"column":19,"offset":784},"end":{"line":33,"column":32,"offset":797},"indent":[]}}],"position":{"start":{"line":33,"column":3,"offset":768},"end":{"line":33,"column":32,"offset":797},"indent":[]}}],"position":{"start":{"line":33,"column":1,"offset":766},"end":{"line":33,"column":32,"offset":797},"indent":[]}},{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"调用","position":{"start":{"line":34,"column":3,"offset":800},"end":{"line":34,"column":5,"offset":802},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">render</code>","position":{"start":{"line":34,"column":5,"offset":802},"end":{"line":34,"column":13,"offset":810},"indent":[]}},{"type":"text","value":"方法去得到children列表并执行比较","position":{"start":{"line":34,"column":13,"offset":810},"end":{"line":34,"column":33,"offset":830},"indent":[]}}],"position":{"start":{"line":34,"column":3,"offset":800},"end":{"line":34,"column":33,"offset":830},"indent":[]}}],"position":{"start":{"line":34,"column":1,"offset":798},"end":{"line":34,"column":33,"offset":830},"indent":[]}},{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"更新","position":{"start":{"line":35,"column":3,"offset":833},"end":{"line":35,"column":5,"offset":835},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">span</code>","position":{"start":{"line":35,"column":5,"offset":835},"end":{"line":35,"column":11,"offset":841},"indent":[]}},{"type":"text","value":"元素的props","position":{"start":{"line":35,"column":11,"offset":841},"end":{"line":35,"column":19,"offset":849},"indent":[]}}],"position":{"start":{"line":35,"column":3,"offset":833},"end":{"line":35,"column":19,"offset":849},"indent":[]}}],"position":{"start":{"line":35,"column":1,"offset":831},"end":{"line":35,"column":19,"offset":849},"indent":[]}}],"position":{"start":{"line":33,"column":1,"offset":766},"end":{"line":35,"column":19,"offset":849},"indent":[1,1]}},{"type":"paragraph","children":[{"type":"text","value":"在","position":{"start":{"line":37,"column":1,"offset":851},"end":{"line":37,"column":2,"offset":852},"indent":[]}},{"type":"link","title":null,"url":"https://github.com/facebook/react/blob/95a313ec0b957f71798a69d8e83408f40e76765b/packages/react-reconciler/src/ReactFiberScheduler.js#L523","children":[{"type":"strong","children":[{"type":"text","value":"commitRoot","position":{"start":{"line":37,"column":5,"offset":855},"end":{"line":37,"column":15,"offset":865},"indent":[]}}],"position":{"start":{"line":37,"column":3,"offset":853},"end":{"line":37,"column":17,"offset":867},"indent":[]}}],"position":{"start":{"line":37,"column":2,"offset":852},"end":{"line":37,"column":157,"offset":1007},"indent":[]}},{"type":"text","value":"：","position":{"start":{"line":37,"column":157,"offset":1007},"end":{"line":37,"column":158,"offset":1008},"indent":[]}}],"position":{"start":{"line":37,"column":1,"offset":851},"end":{"line":37,"column":158,"offset":1008},"indent":[]}},{"type":"list","ordered":false,"start":null,"loose":false,"children":[{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"更新","position":{"start":{"line":39,"column":3,"offset":1012},"end":{"line":39,"column":5,"offset":1014},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">span</code>","position":{"start":{"line":39,"column":5,"offset":1014},"end":{"line":39,"column":11,"offset":1020},"indent":[]}},{"type":"text","value":"元素的","position":{"start":{"line":39,"column":11,"offset":1020},"end":{"line":39,"column":14,"offset":1023},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">textContent</code>","position":{"start":{"line":39,"column":14,"offset":1023},"end":{"line":39,"column":27,"offset":1036},"indent":[]}},{"type":"text","value":"属性","position":{"start":{"line":39,"column":27,"offset":1036},"end":{"line":39,"column":29,"offset":1038},"indent":[]}}],"position":{"start":{"line":39,"column":3,"offset":1012},"end":{"line":39,"column":29,"offset":1038},"indent":[]}}],"position":{"start":{"line":39,"column":1,"offset":1010},"end":{"line":39,"column":29,"offset":1038},"indent":[]}},{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"调用","position":{"start":{"line":40,"column":3,"offset":1041},"end":{"line":40,"column":5,"offset":1043},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">cDU</code>","position":{"start":{"line":40,"column":5,"offset":1043},"end":{"line":40,"column":10,"offset":1048},"indent":[]}}],"position":{"start":{"line":40,"column":3,"offset":1041},"end":{"line":40,"column":10,"offset":1048},"indent":[]}}],"position":{"start":{"line":40,"column":1,"offset":1039},"end":{"line":40,"column":10,"offset":1048},"indent":[]}}],"position":{"start":{"line":39,"column":1,"offset":1010},"end":{"line":40,"column":10,"offset":1048},"indent":[1]}},{"type":"heading","depth":2,"children":[{"type":"text","value":"render阶段","position":{"start":{"line":42,"column":4,"offset":1053},"end":{"line":42,"column":12,"offset":1061},"indent":[]}}],"position":{"start":{"line":42,"column":1,"offset":1050},"end":{"line":42,"column":12,"offset":1061},"indent":[]}},{"type":"heading","depth":3,"children":[{"type":"text","value":"Scheduling updates（安排更新）","position":{"start":{"line":44,"column":5,"offset":1067},"end":{"line":44,"column":29,"offset":1091},"indent":[]}}],"position":{"start":{"line":44,"column":1,"offset":1063},"end":{"line":44,"column":29,"offset":1091},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"​\t当我们点击按钮，会触发点击事件然后react解析我们传给按钮props的callback。在这个应用中callback是增加counter并更新state。","position":{"start":{"line":46,"column":1,"offset":1093},"end":{"line":46,"column":81,"offset":1173},"indent":[]}}],"position":{"start":{"line":46,"column":1,"offset":1093},"end":{"line":46,"column":81,"offset":1173},"indent":[]}},{"type":"html","lang":"jsx","value":"<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">ClickCounter</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">React<span class=\"token punctuation\">.</span>Component</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//...</span>\n    <span class=\"token function\">handleClick</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>count<span class=\"token punctuation\">:</span> state<span class=\"token punctuation\">.</span>count <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>   </code></pre></div>","position":{"start":{"line":48,"column":1,"offset":1175},"end":{"line":57,"column":4,"offset":1363},"indent":[1,1,1,1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"​\t\t每一个React组件都有一个","position":{"start":{"line":59,"column":1,"offset":1365},"end":{"line":59,"column":18,"offset":1382},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">updater</code>","position":{"start":{"line":59,"column":18,"offset":1382},"end":{"line":59,"column":27,"offset":1391},"indent":[]}},{"type":"text","value":"作为组件和react核心通信的桥梁。他允许","position":{"start":{"line":59,"column":27,"offset":1391},"end":{"line":59,"column":48,"offset":1412},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">setState</code>","position":{"start":{"line":59,"column":48,"offset":1412},"end":{"line":59,"column":58,"offset":1422},"indent":[]}},{"type":"text","value":"在不同的环境下（ReactDOM，RN， SSR， test）实现不同的效果","position":{"start":{"line":59,"column":58,"offset":1422},"end":{"line":59,"column":96,"offset":1460},"indent":[]}}],"position":{"start":{"line":59,"column":1,"offset":1365},"end":{"line":59,"column":96,"offset":1460},"indent":[]}},{"type":"blockquote","children":[{"type":"paragraph","children":[{"type":"text","value":"注：关于updater，可以关联学习dan大神博客的","position":{"start":{"line":61,"column":3,"offset":1464},"end":{"line":61,"column":29,"offset":1490},"indent":[]}},{"type":"link","title":null,"url":"https://overreacted.io/how-does-setstate-know-what-to-do/","children":[{"type":"text","value":"How Does setState Know What to Do?","position":{"start":{"line":61,"column":30,"offset":1491},"end":{"line":61,"column":64,"offset":1525},"indent":[]}}],"position":{"start":{"line":61,"column":29,"offset":1490},"end":{"line":61,"column":125,"offset":1586},"indent":[]}},{"type":"text","value":" ","position":{"start":{"line":61,"column":125,"offset":1586},"end":{"line":61,"column":126,"offset":1587},"indent":[]}}],"position":{"start":{"line":61,"column":3,"offset":1464},"end":{"line":61,"column":126,"offset":1587},"indent":[]}}],"position":{"start":{"line":61,"column":1,"offset":1462},"end":{"line":61,"column":126,"offset":1587},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"​\t在这篇文章中，我们会侧重ReactDom的使用了Fiber reconciler的updater实现，对于","position":{"start":{"line":63,"column":1,"offset":1589},"end":{"line":63,"column":56,"offset":1644},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">ClickCounter</code>","position":{"start":{"line":63,"column":56,"offset":1644},"end":{"line":63,"column":70,"offset":1658},"indent":[]}},{"type":"text","value":"组件是","position":{"start":{"line":63,"column":70,"offset":1658},"end":{"line":63,"column":73,"offset":1661},"indent":[]}},{"type":"link","title":null,"url":"https://github.com/facebook/react/blob/6938dcaacbffb901df27782b7821836961a5b68d/packages/react-reconciler/src/ReactFiberClassComponent.js#L186","children":[{"type":"strong","children":[{"type":"text","value":"classComponentUpdater","position":{"start":{"line":63,"column":76,"offset":1664},"end":{"line":63,"column":97,"offset":1685},"indent":[]}}],"position":{"start":{"line":63,"column":74,"offset":1662},"end":{"line":63,"column":99,"offset":1687},"indent":[]}}],"position":{"start":{"line":63,"column":73,"offset":1661},"end":{"line":63,"column":244,"offset":1832},"indent":[]}},{"type":"text","value":"，他负责检索fiber实例，队列更新和安排工作。","position":{"start":{"line":63,"column":244,"offset":1832},"end":{"line":63,"column":268,"offset":1856},"indent":[]}}],"position":{"start":{"line":63,"column":1,"offset":1589},"end":{"line":63,"column":268,"offset":1856},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"​\t当更新排队时，他们基本上只是被添加到fiber节点上处理的更新队列中。在我们的实例中，与ClickCounter组件对应的fiber节点有以下的结构","position":{"start":{"line":65,"column":1,"offset":1858},"end":{"line":65,"column":77,"offset":1934},"indent":[]}}],"position":{"start":{"line":65,"column":1,"offset":1858},"end":{"line":65,"column":77,"offset":1934},"indent":[]}},{"type":"html","lang":"javascript","value":"<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n    stateNode<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ClickCounter</span><span class=\"token punctuation\">,</span>\n    type<span class=\"token punctuation\">:</span> ClickCounter<span class=\"token punctuation\">,</span>\n    updateQueue<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n         baseState<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>count<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">}</span>\n         firstUpdate<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n             next<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n                 payload<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>count<span class=\"token punctuation\">:</span> state<span class=\"token punctuation\">.</span>count <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span>\n             <span class=\"token punctuation\">}</span>\n         <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n         <span class=\"token operator\">...</span>\n     <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n     <span class=\"token operator\">...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","position":{"start":{"line":67,"column":1,"offset":1936},"end":{"line":82,"column":4,"offset":2239},"indent":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"我们可以看到，","position":{"start":{"line":84,"column":1,"offset":2241},"end":{"line":84,"column":8,"offset":2248},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">updateQueue.firstUpdate.next.payload</code>","position":{"start":{"line":84,"column":8,"offset":2248},"end":{"line":84,"column":46,"offset":2286},"indent":[]}},{"type":"text","value":"中的函数是我们传给","position":{"start":{"line":84,"column":46,"offset":2286},"end":{"line":84,"column":55,"offset":2295},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">ClickCounter</code>","position":{"start":{"line":84,"column":55,"offset":2295},"end":{"line":84,"column":69,"offset":2309},"indent":[]}},{"type":"text","value":"组件中setState的callback。他表示在render阶段需要被处理的第一个更新。","position":{"start":{"line":84,"column":69,"offset":2309},"end":{"line":84,"column":114,"offset":2354},"indent":[]}}],"position":{"start":{"line":84,"column":1,"offset":2241},"end":{"line":84,"column":114,"offset":2354},"indent":[]}},{"type":"heading","depth":3,"children":[{"type":"text","value":"处理ClickCounter Fiber结点的更新","position":{"start":{"line":86,"column":5,"offset":2360},"end":{"line":86,"column":30,"offset":2385},"indent":[]}}],"position":{"start":{"line":86,"column":1,"offset":2356},"end":{"line":86,"column":30,"offset":2385},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"​\t我们已经有一个ClickCounter实例，所以我们进入","position":{"start":{"line":88,"column":1,"offset":2387},"end":{"line":88,"column":31,"offset":2417},"indent":[]}},{"type":"link","title":null,"url":"https://github.com/facebook/react/blob/6938dcaacbffb901df27782b7821836961a5b68d/packages/react-reconciler/src/ReactFiberClassComponent.js#L976","children":[{"type":"strong","children":[{"type":"text","value":"updateClassInstance","position":{"start":{"line":88,"column":34,"offset":2420},"end":{"line":88,"column":53,"offset":2439},"indent":[]}}],"position":{"start":{"line":88,"column":32,"offset":2418},"end":{"line":88,"column":55,"offset":2441},"indent":[]}}],"position":{"start":{"line":88,"column":31,"offset":2417},"end":{"line":88,"column":200,"offset":2586},"indent":[]}},{"type":"text","value":"函数，这里是react对class组件执行最多操作的函数。以下是按执行顺序在函数中执行的最重要的操作：","position":{"start":{"line":88,"column":200,"offset":2586},"end":{"line":88,"column":251,"offset":2637},"indent":[]}}],"position":{"start":{"line":88,"column":1,"offset":2387},"end":{"line":88,"column":251,"offset":2637},"indent":[]}},{"type":"list","ordered":false,"start":null,"loose":false,"children":[{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"调用","position":{"start":{"line":90,"column":3,"offset":2641},"end":{"line":90,"column":5,"offset":2643},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"UNSAFE_componentWillReceiveProps","position":{"start":{"line":90,"column":7,"offset":2645},"end":{"line":90,"column":39,"offset":2677},"indent":[]}}],"position":{"start":{"line":90,"column":5,"offset":2643},"end":{"line":90,"column":41,"offset":2679},"indent":[]}},{"type":"text","value":"钩子（在react v17中弃用）","position":{"start":{"line":90,"column":41,"offset":2679},"end":{"line":90,"column":58,"offset":2696},"indent":[]}}],"position":{"start":{"line":90,"column":3,"offset":2641},"end":{"line":90,"column":58,"offset":2696},"indent":[]}}],"position":{"start":{"line":90,"column":1,"offset":2639},"end":{"line":90,"column":58,"offset":2696},"indent":[]}},{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"执行","position":{"start":{"line":91,"column":3,"offset":2699},"end":{"line":91,"column":5,"offset":2701},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"updateQueue","position":{"start":{"line":91,"column":7,"offset":2703},"end":{"line":91,"column":18,"offset":2714},"indent":[]}}],"position":{"start":{"line":91,"column":5,"offset":2701},"end":{"line":91,"column":20,"offset":2716},"indent":[]}},{"type":"text","value":"中的更新并生成新的state","position":{"start":{"line":91,"column":20,"offset":2716},"end":{"line":91,"column":34,"offset":2730},"indent":[]}}],"position":{"start":{"line":91,"column":3,"offset":2699},"end":{"line":91,"column":34,"offset":2730},"indent":[]}}],"position":{"start":{"line":91,"column":1,"offset":2697},"end":{"line":91,"column":34,"offset":2730},"indent":[]}},{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"用新的state调用","position":{"start":{"line":92,"column":3,"offset":2733},"end":{"line":92,"column":13,"offset":2743},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"getDerivedStateFromProps","position":{"start":{"line":92,"column":15,"offset":2745},"end":{"line":92,"column":39,"offset":2769},"indent":[]}}],"position":{"start":{"line":92,"column":13,"offset":2743},"end":{"line":92,"column":41,"offset":2771},"indent":[]}},{"type":"text","value":"并得到结果","position":{"start":{"line":92,"column":41,"offset":2771},"end":{"line":92,"column":46,"offset":2776},"indent":[]}}],"position":{"start":{"line":92,"column":3,"offset":2733},"end":{"line":92,"column":46,"offset":2776},"indent":[]}}],"position":{"start":{"line":92,"column":1,"offset":2731},"end":{"line":92,"column":46,"offset":2776},"indent":[]}},{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"调用","position":{"start":{"line":93,"column":3,"offset":2779},"end":{"line":93,"column":5,"offset":2781},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"sCU","position":{"start":{"line":93,"column":7,"offset":2783},"end":{"line":93,"column":10,"offset":2786},"indent":[]}}],"position":{"start":{"line":93,"column":5,"offset":2781},"end":{"line":93,"column":12,"offset":2788},"indent":[]}},{"type":"text","value":"确定一个组件是否需要更新，如果","position":{"start":{"line":93,"column":12,"offset":2788},"end":{"line":93,"column":27,"offset":2803},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"false","position":{"start":{"line":93,"column":29,"offset":2805},"end":{"line":93,"column":34,"offset":2810},"indent":[]}}],"position":{"start":{"line":93,"column":27,"offset":2803},"end":{"line":93,"column":36,"offset":2812},"indent":[]}},{"type":"text","value":"，跳过整个渲染过程","position":{"start":{"line":93,"column":36,"offset":2812},"end":{"line":93,"column":45,"offset":2821},"indent":[]}}],"position":{"start":{"line":93,"column":3,"offset":2779},"end":{"line":93,"column":45,"offset":2821},"indent":[]}}],"position":{"start":{"line":93,"column":1,"offset":2777},"end":{"line":93,"column":45,"offset":2821},"indent":[]}},{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"调用","position":{"start":{"line":94,"column":3,"offset":2824},"end":{"line":94,"column":5,"offset":2826},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"UNSAFE_componentWillUpdate","position":{"start":{"line":94,"column":7,"offset":2828},"end":{"line":94,"column":33,"offset":2854},"indent":[]}}],"position":{"start":{"line":94,"column":5,"offset":2826},"end":{"line":94,"column":35,"offset":2856},"indent":[]}},{"type":"text","value":"钩子（在react v17中弃用）","position":{"start":{"line":94,"column":35,"offset":2856},"end":{"line":94,"column":52,"offset":2873},"indent":[]}}],"position":{"start":{"line":94,"column":3,"offset":2824},"end":{"line":94,"column":52,"offset":2873},"indent":[]}}],"position":{"start":{"line":94,"column":1,"offset":2822},"end":{"line":94,"column":52,"offset":2873},"indent":[]}},{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"添加一个effect去触发","position":{"start":{"line":95,"column":3,"offset":2876},"end":{"line":95,"column":16,"offset":2889},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"componentDidUpdate","position":{"start":{"line":95,"column":18,"offset":2891},"end":{"line":95,"column":36,"offset":2909},"indent":[]}}],"position":{"start":{"line":95,"column":16,"offset":2889},"end":{"line":95,"column":38,"offset":2911},"indent":[]}},{"type":"text","value":"钩子","position":{"start":{"line":95,"column":38,"offset":2911},"end":{"line":95,"column":40,"offset":2913},"indent":[]}}],"position":{"start":{"line":95,"column":3,"offset":2876},"end":{"line":95,"column":40,"offset":2913},"indent":[]}}],"position":{"start":{"line":95,"column":1,"offset":2874},"end":{"line":95,"column":40,"offset":2913},"indent":[]}}],"position":{"start":{"line":90,"column":1,"offset":2639},"end":{"line":95,"column":40,"offset":2913},"indent":[1,1,1,1,1]}},{"type":"blockquote","children":[{"type":"paragraph","children":[{"type":"strong","children":[{"type":"text","value":"cDU","position":{"start":{"line":97,"column":5,"offset":2919},"end":{"line":97,"column":8,"offset":2922},"indent":[]}}],"position":{"start":{"line":97,"column":3,"offset":2917},"end":{"line":97,"column":10,"offset":2924},"indent":[]}},{"type":"text","value":"这个effect在","position":{"start":{"line":97,"column":10,"offset":2924},"end":{"line":97,"column":19,"offset":2933},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"render","position":{"start":{"line":97,"column":21,"offset":2935},"end":{"line":97,"column":27,"offset":2941},"indent":[]}}],"position":{"start":{"line":97,"column":19,"offset":2933},"end":{"line":97,"column":29,"offset":2943},"indent":[]}},{"type":"text","value":"阶段中被添加，但是在","position":{"start":{"line":97,"column":29,"offset":2943},"end":{"line":97,"column":39,"offset":2953},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"commit","position":{"start":{"line":97,"column":41,"offset":2955},"end":{"line":97,"column":47,"offset":2961},"indent":[]}}],"position":{"start":{"line":97,"column":39,"offset":2953},"end":{"line":97,"column":49,"offset":2963},"indent":[]}},{"type":"text","value":"中执行","position":{"start":{"line":97,"column":49,"offset":2963},"end":{"line":97,"column":52,"offset":2966},"indent":[]}}],"position":{"start":{"line":97,"column":3,"offset":2917},"end":{"line":97,"column":52,"offset":2966},"indent":[]}}],"position":{"start":{"line":97,"column":1,"offset":2915},"end":{"line":97,"column":52,"offset":2966},"indent":[]}},{"type":"list","ordered":false,"start":null,"loose":false,"children":[{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"更新组件实例的","position":{"start":{"line":99,"column":3,"offset":2970},"end":{"line":99,"column":10,"offset":2977},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"state","position":{"start":{"line":99,"column":12,"offset":2979},"end":{"line":99,"column":17,"offset":2984},"indent":[]}}],"position":{"start":{"line":99,"column":10,"offset":2977},"end":{"line":99,"column":19,"offset":2986},"indent":[]}},{"type":"text","value":"和","position":{"start":{"line":99,"column":19,"offset":2986},"end":{"line":99,"column":20,"offset":2987},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"props","position":{"start":{"line":99,"column":22,"offset":2989},"end":{"line":99,"column":27,"offset":2994},"indent":[]}}],"position":{"start":{"line":99,"column":20,"offset":2987},"end":{"line":99,"column":29,"offset":2996},"indent":[]}}],"position":{"start":{"line":99,"column":3,"offset":2970},"end":{"line":99,"column":29,"offset":2996},"indent":[]}}],"position":{"start":{"line":99,"column":1,"offset":2968},"end":{"line":99,"column":29,"offset":2996},"indent":[]}}],"position":{"start":{"line":99,"column":1,"offset":2968},"end":{"line":99,"column":29,"offset":2996},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"函数简化后如下：","position":{"start":{"line":101,"column":1,"offset":2998},"end":{"line":101,"column":9,"offset":3006},"indent":[]}}],"position":{"start":{"line":101,"column":1,"offset":2998},"end":{"line":101,"column":9,"offset":3006},"indent":[]}},{"type":"html","lang":"javascript","value":"<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">updateClassInstance</span><span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">,</span> workInProgress<span class=\"token punctuation\">,</span> ctor<span class=\"token punctuation\">,</span> newProps<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> instance <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>stateNode<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> oldProps <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>memoizedProps<span class=\"token punctuation\">;</span>\n    instance<span class=\"token punctuation\">.</span>props <span class=\"token operator\">=</span> oldProps<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oldProps <span class=\"token operator\">!==</span> newProps<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">callComponentWillReceiveProps</span><span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">,</span> instance<span class=\"token punctuation\">,</span> newProps<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">let</span> updateQueue <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>updateQueue<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>updateQueue <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">processUpdateQueue</span><span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">,</span> updateQueue<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        newState <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>memoizedState<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token function\">applyDerivedStateFromProps</span><span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    newState <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>memoizedState<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> shouldUpdate <span class=\"token operator\">=</span> <span class=\"token function\">checkShouldComponentUpdate</span><span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">,</span> ctor<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>shouldUpdate<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        instance<span class=\"token punctuation\">.</span><span class=\"token function\">componentWillUpdate</span><span class=\"token punctuation\">(</span>newProps<span class=\"token punctuation\">,</span> newState<span class=\"token punctuation\">,</span> nextContext<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        workInProgress<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">|=</span> Update<span class=\"token punctuation\">;</span>\n        workInProgress<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">|=</span> Snapshot<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    instance<span class=\"token punctuation\">.</span>props <span class=\"token operator\">=</span> newProps<span class=\"token punctuation\">;</span>\n    instance<span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> newState<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> shouldUpdate<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","position":{"start":{"line":103,"column":1,"offset":3008},"end":{"line":134,"column":4,"offset":4013},"indent":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"上面的代码片段移除了一些辅助代码。例如，在调用生命周期方法或添加effect来触发它们时，react会用","position":{"start":{"line":136,"column":1,"offset":4015},"end":{"line":136,"column":53,"offset":4067},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"typeof","position":{"start":{"line":136,"column":55,"offset":4069},"end":{"line":136,"column":61,"offset":4075},"indent":[]}}],"position":{"start":{"line":136,"column":53,"offset":4067},"end":{"line":136,"column":63,"offset":4077},"indent":[]}},{"type":"text","value":"检查一个组件是否实现了这些方法。下面是react在添加effect前检查","position":{"start":{"line":136,"column":63,"offset":4077},"end":{"line":136,"column":99,"offset":4113},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"cDU","position":{"start":{"line":136,"column":101,"offset":4115},"end":{"line":136,"column":104,"offset":4118},"indent":[]}}],"position":{"start":{"line":136,"column":99,"offset":4113},"end":{"line":136,"column":106,"offset":4120},"indent":[]}},{"type":"text","value":"方法","position":{"start":{"line":136,"column":106,"offset":4120},"end":{"line":136,"column":108,"offset":4122},"indent":[]}}],"position":{"start":{"line":136,"column":1,"offset":4015},"end":{"line":136,"column":108,"offset":4122},"indent":[]}},{"type":"html","lang":"javascript","value":"<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> instance<span class=\"token punctuation\">.</span>componentDidUpdate <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    workInProgress<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">|=</span> Update<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","position":{"start":{"line":138,"column":1,"offset":4124},"end":{"line":142,"column":4,"offset":4240},"indent":[1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"好的，现在我们知道在render阶段","position":{"start":{"line":144,"column":1,"offset":4242},"end":{"line":144,"column":19,"offset":4260},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"ClickCounter","position":{"start":{"line":144,"column":21,"offset":4262},"end":{"line":144,"column":33,"offset":4274},"indent":[]}}],"position":{"start":{"line":144,"column":19,"offset":4260},"end":{"line":144,"column":35,"offset":4276},"indent":[]}},{"type":"text","value":"会执行什么操作，现在让我们看看这些操作是怎么改变fiber节点的值。当react开始工作前，","position":{"start":{"line":144,"column":35,"offset":4276},"end":{"line":144,"column":81,"offset":4322},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"ClickCounter","position":{"start":{"line":144,"column":83,"offset":4324},"end":{"line":144,"column":95,"offset":4336},"indent":[]}}],"position":{"start":{"line":144,"column":81,"offset":4322},"end":{"line":144,"column":97,"offset":4338},"indent":[]}},{"type":"text","value":"的fiber节点：","position":{"start":{"line":144,"column":97,"offset":4338},"end":{"line":144,"column":106,"offset":4347},"indent":[]}}],"position":{"start":{"line":144,"column":1,"offset":4242},"end":{"line":144,"column":106,"offset":4347},"indent":[]}},{"type":"html","lang":"javascript","value":"<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n    effectTag<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n    elementType<span class=\"token punctuation\">:</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ClickCounter</span><span class=\"token punctuation\">,</span>\n    firstEffect<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    memoizedState<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>count<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    type<span class=\"token punctuation\">:</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ClickCounter</span><span class=\"token punctuation\">,</span>\n    stateNode<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        state<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>count<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    updateQueue<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        baseState<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>count<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        firstUpdate<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n            next<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n                payload<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">,</span> props<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>…<span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token operator\">...</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","position":{"start":{"line":146,"column":1,"offset":4349},"end":{"line":166,"column":4,"offset":4742},"indent":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"在工作完成后，fiber节点是这样的：","position":{"start":{"line":168,"column":1,"offset":4744},"end":{"line":168,"column":20,"offset":4763},"indent":[]}}],"position":{"start":{"line":168,"column":1,"offset":4744},"end":{"line":168,"column":20,"offset":4763},"indent":[]}},{"type":"html","lang":"javascript","value":"<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n    effectTag<span class=\"token punctuation\">:</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span>\n    elementType<span class=\"token punctuation\">:</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ClickCounter</span><span class=\"token punctuation\">,</span>\n    firstEffect<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    memoizedState<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>count<span class=\"token punctuation\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    type<span class=\"token punctuation\">:</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ClickCounter</span><span class=\"token punctuation\">,</span>\n    stateNode<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        state<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>count<span class=\"token punctuation\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    updateQueue<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        baseState<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>count<span class=\"token punctuation\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        firstUpdate<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n        <span class=\"token operator\">...</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","position":{"start":{"line":170,"column":1,"offset":4765},"end":{"line":186,"column":4,"offset":5070},"indent":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"在更新被执行后，","position":{"start":{"line":188,"column":1,"offset":5072},"end":{"line":188,"column":9,"offset":5080},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"count","position":{"start":{"line":188,"column":11,"offset":5082},"end":{"line":188,"column":16,"offset":5087},"indent":[]}}],"position":{"start":{"line":188,"column":9,"offset":5080},"end":{"line":188,"column":18,"offset":5089},"indent":[]}},{"type":"text","value":"的值在","position":{"start":{"line":188,"column":18,"offset":5089},"end":{"line":188,"column":21,"offset":5092},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"memoized","position":{"start":{"line":188,"column":23,"offset":5094},"end":{"line":188,"column":31,"offset":5102},"indent":[]}}],"position":{"start":{"line":188,"column":21,"offset":5092},"end":{"line":188,"column":33,"offset":5104},"indent":[]}},{"type":"text","value":"和","position":{"start":{"line":188,"column":33,"offset":5104},"end":{"line":188,"column":34,"offset":5105},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"updateQueue","position":{"start":{"line":188,"column":36,"offset":5107},"end":{"line":188,"column":47,"offset":5118},"indent":[]}}],"position":{"start":{"line":188,"column":34,"offset":5105},"end":{"line":188,"column":49,"offset":5120},"indent":[]}},{"type":"text","value":"中的","position":{"start":{"line":188,"column":49,"offset":5120},"end":{"line":188,"column":51,"offset":5122},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"baseState","position":{"start":{"line":188,"column":53,"offset":5124},"end":{"line":188,"column":62,"offset":5133},"indent":[]}}],"position":{"start":{"line":188,"column":51,"offset":5122},"end":{"line":188,"column":64,"offset":5135},"indent":[]}},{"type":"text","value":"变成了","position":{"start":{"line":188,"column":64,"offset":5135},"end":{"line":188,"column":67,"offset":5138},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"1","position":{"start":{"line":188,"column":69,"offset":5140},"end":{"line":188,"column":70,"offset":5141},"indent":[]}}],"position":{"start":{"line":188,"column":67,"offset":5138},"end":{"line":188,"column":72,"offset":5143},"indent":[]}},{"type":"text","value":"。react也更新了","position":{"start":{"line":188,"column":72,"offset":5143},"end":{"line":188,"column":82,"offset":5153},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"ClickCounter","position":{"start":{"line":188,"column":84,"offset":5155},"end":{"line":188,"column":96,"offset":5167},"indent":[]}}],"position":{"start":{"line":188,"column":82,"offset":5153},"end":{"line":188,"column":98,"offset":5169},"indent":[]}},{"type":"text","value":"组件实例中的state(stateNode)。","position":{"start":{"line":188,"column":98,"offset":5169},"end":{"line":188,"column":121,"offset":5192},"indent":[]}}],"position":{"start":{"line":188,"column":1,"offset":5072},"end":{"line":188,"column":121,"offset":5192},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"在这个时候，队列中已经没有更新了，所以","position":{"start":{"line":190,"column":1,"offset":5194},"end":{"line":190,"column":20,"offset":5213},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"firstUpdate","position":{"start":{"line":190,"column":22,"offset":5215},"end":{"line":190,"column":33,"offset":5226},"indent":[]}}],"position":{"start":{"line":190,"column":20,"offset":5213},"end":{"line":190,"column":35,"offset":5228},"indent":[]}},{"type":"text","value":"是","position":{"start":{"line":190,"column":35,"offset":5228},"end":{"line":190,"column":36,"offset":5229},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"null","position":{"start":{"line":190,"column":38,"offset":5231},"end":{"line":190,"column":42,"offset":5235},"indent":[]}}],"position":{"start":{"line":190,"column":36,"offset":5229},"end":{"line":190,"column":44,"offset":5237},"indent":[]}},{"type":"text","value":"。而且","position":{"start":{"line":190,"column":44,"offset":5237},"end":{"line":190,"column":47,"offset":5240},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"effectTag","position":{"start":{"line":190,"column":49,"offset":5242},"end":{"line":190,"column":58,"offset":5251},"indent":[]}}],"position":{"start":{"line":190,"column":47,"offset":5240},"end":{"line":190,"column":60,"offset":5253},"indent":[]}},{"type":"text","value":"从0->4，二进制中是100，即第三位设了1，意义是 ","position":{"start":{"line":190,"column":60,"offset":5253},"end":{"line":190,"column":87,"offset":5280},"indent":[]}},{"type":"link","title":null,"url":"https://github.com/facebook/react/blob/b87aabdfe1b7461e7331abb3601d9e6bb27544bc/packages/shared/ReactSideEffectTags.js","children":[{"type":"text","value":"side-effect tag","position":{"start":{"line":190,"column":88,"offset":5281},"end":{"line":190,"column":103,"offset":5296},"indent":[]}}],"position":{"start":{"line":190,"column":87,"offset":5280},"end":{"line":190,"column":224,"offset":5417},"indent":[]}},{"type":"text","value":"中的","position":{"start":{"line":190,"column":224,"offset":5417},"end":{"line":190,"column":226,"offset":5419},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"Update","position":{"start":{"line":190,"column":228,"offset":5421},"end":{"line":190,"column":234,"offset":5427},"indent":[]}}],"position":{"start":{"line":190,"column":226,"offset":5419},"end":{"line":190,"column":236,"offset":5429},"indent":[]}},{"type":"text","value":":","position":{"start":{"line":190,"column":236,"offset":5429},"end":{"line":190,"column":237,"offset":5430},"indent":[]}}],"position":{"start":{"line":190,"column":1,"offset":5194},"end":{"line":190,"column":237,"offset":5430},"indent":[]}},{"type":"html","lang":"javascript","value":"<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> Update <span class=\"token operator\">=</span> <span class=\"token number\">0b00000000100</span><span class=\"token punctuation\">;</span></code></pre></div>","position":{"start":{"line":192,"column":1,"offset":5432},"end":{"line":194,"column":4,"offset":5486},"indent":[1,1]}},{"type":"paragraph","children":[{"type":"text","value":"总结，当在处理ClickCounter fiber节点时，react调用更新前的生命周期，更新state和定义相应的side-effects。","position":{"start":{"line":196,"column":1,"offset":5488},"end":{"line":196,"column":72,"offset":5559},"indent":[]}}],"position":{"start":{"line":196,"column":1,"offset":5488},"end":{"line":196,"column":72,"offset":5559},"indent":[]}},{"type":"heading","depth":3,"children":[{"type":"text","value":"Reconciling children for the ClickCounter Fiber","position":{"start":{"line":198,"column":5,"offset":5565},"end":{"line":198,"column":52,"offset":5612},"indent":[]}}],"position":{"start":{"line":198,"column":1,"offset":5561},"end":{"line":198,"column":52,"offset":5612},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"下一步，react开始 ","position":{"start":{"line":200,"column":1,"offset":5614},"end":{"line":200,"column":13,"offset":5626},"indent":[]}},{"type":"link","title":null,"url":"https://github.com/facebook/react/blob/340bfd9393e8173adca5380e6587e1ea1a23cefa/packages/react-reconciler/src/ReactFiberBeginWork.js#L355","children":[{"type":"text","value":"finishClassComponent","position":{"start":{"line":200,"column":14,"offset":5627},"end":{"line":200,"column":34,"offset":5647},"indent":[]}}],"position":{"start":{"line":200,"column":13,"offset":5626},"end":{"line":200,"column":174,"offset":5787},"indent":[]}},{"type":"text","value":"，在这里react会调用react组件实例的","position":{"start":{"line":200,"column":174,"offset":5787},"end":{"line":200,"column":196,"offset":5809},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"render","position":{"start":{"line":200,"column":198,"offset":5811},"end":{"line":200,"column":204,"offset":5817},"indent":[]}}],"position":{"start":{"line":200,"column":196,"offset":5809},"end":{"line":200,"column":206,"offset":5819},"indent":[]}},{"type":"text","value":"方法并在组件返回的的孩子上应用diff算法。更高阶的概述在这个","position":{"start":{"line":200,"column":206,"offset":5819},"end":{"line":200,"column":237,"offset":5850},"indent":[]}},{"type":"link","title":null,"url":"https://reactjs.org/docs/reconciliation.html#the-diffing-algorithm","children":[{"type":"text","value":"文档","position":{"start":{"line":200,"column":238,"offset":5851},"end":{"line":200,"column":240,"offset":5853},"indent":[]}}],"position":{"start":{"line":200,"column":237,"offset":5850},"end":{"line":200,"column":309,"offset":5922},"indent":[]}},{"type":"text","value":"。","position":{"start":{"line":200,"column":309,"offset":5922},"end":{"line":200,"column":310,"offset":5923},"indent":[]}}],"position":{"start":{"line":200,"column":1,"offset":5614},"end":{"line":200,"column":310,"offset":5923},"indent":[]}},{"type":"blockquote","children":[{"type":"paragraph","children":[{"type":"text","value":"当比较两个相同类型的React DOM元素时，React查看两者的属性，保持相同的底层DOM节点，并仅更新更改的属性。","position":{"start":{"line":202,"column":3,"offset":5927},"end":{"line":202,"column":62,"offset":5986},"indent":[]}}],"position":{"start":{"line":202,"column":3,"offset":5927},"end":{"line":202,"column":62,"offset":5986},"indent":[]}}],"position":{"start":{"line":202,"column":1,"offset":5925},"end":{"line":202,"column":62,"offset":5986},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"如果我们深入挖掘，我们会发现实际上是比较react元素的fiber节点，但我现在不会详细介绍，因为这个过程非常精细。我会写一篇单独的文章，特别关注child reconciliation。","position":{"start":{"line":204,"column":1,"offset":5988},"end":{"line":204,"column":95,"offset":6082},"indent":[]}}],"position":{"start":{"line":204,"column":1,"offset":5988},"end":{"line":204,"column":95,"offset":6082},"indent":[]}},{"type":"blockquote","children":[{"type":"paragraph","children":[{"type":"text","value":"如果您急于自己学习细节，查看","position":{"start":{"line":206,"column":3,"offset":6086},"end":{"line":206,"column":17,"offset":6100},"indent":[]}},{"type":"link","title":null,"url":"https://github.com/facebook/react/blob/95a313ec0b957f71798a69d8e83408f40e76765b/packages/react-reconciler/src/ReactChildFiber.js#L732","children":[{"type":"text","value":"reconcileChildrenArray","position":{"start":{"line":206,"column":18,"offset":6101},"end":{"line":206,"column":40,"offset":6123},"indent":[]}}],"position":{"start":{"line":206,"column":17,"offset":6100},"end":{"line":206,"column":176,"offset":6259},"indent":[]}},{"type":"text","value":"函数因为我们这个应用的render方法返回了一个react元素的数组。","position":{"start":{"line":206,"column":176,"offset":6259},"end":{"line":206,"column":211,"offset":6294},"indent":[]}}],"position":{"start":{"line":206,"column":3,"offset":6086},"end":{"line":206,"column":211,"offset":6294},"indent":[]}}],"position":{"start":{"line":206,"column":1,"offset":6084},"end":{"line":206,"column":211,"offset":6294},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"我们需要理解两个重要的概念：","position":{"start":{"line":208,"column":1,"offset":6296},"end":{"line":208,"column":15,"offset":6310},"indent":[]}}],"position":{"start":{"line":208,"column":1,"offset":6296},"end":{"line":208,"column":15,"offset":6310},"indent":[]}},{"type":"list","ordered":true,"start":1,"loose":true,"children":[{"type":"listItem","loose":true,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"当react执行child reconciliation时，他创建或更新render方法返回的reac元素的fiber节点。","position":{"start":{"line":210,"column":4,"offset":6315},"end":{"line":210,"column":66,"offset":6377},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"finishClassComponent","position":{"start":{"line":210,"column":68,"offset":6379},"end":{"line":210,"column":88,"offset":6399},"indent":[]}}],"position":{"start":{"line":210,"column":66,"offset":6377},"end":{"line":210,"column":90,"offset":6401},"indent":[]}},{"type":"text","value":"函数返回当前fiber节点第一个孩子的引用。它会分配到","position":{"start":{"line":210,"column":90,"offset":6401},"end":{"line":210,"column":117,"offset":6428},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"nextUnitOfWork","position":{"start":{"line":210,"column":119,"offset":6430},"end":{"line":210,"column":133,"offset":6444},"indent":[]}}],"position":{"start":{"line":210,"column":117,"offset":6428},"end":{"line":210,"column":135,"offset":6446},"indent":[]}},{"type":"text","value":"并在稍后的work loop中处理。","position":{"start":{"line":210,"column":135,"offset":6446},"end":{"line":210,"column":153,"offset":6464},"indent":[]}}],"position":{"start":{"line":210,"column":4,"offset":6315},"end":{"line":210,"column":153,"offset":6464},"indent":[]}}],"position":{"start":{"line":210,"column":1,"offset":6312},"end":{"line":211,"column":1,"offset":6465},"indent":[1]}},{"type":"listItem","loose":true,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"react更新children的props作为parent工作的一部分。为此，它使用来自render方法返回的React元素的数据。例如，这是","position":{"start":{"line":212,"column":4,"offset":6469},"end":{"line":212,"column":75,"offset":6540},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"span","position":{"start":{"line":212,"column":77,"offset":6542},"end":{"line":212,"column":81,"offset":6546},"indent":[]}}],"position":{"start":{"line":212,"column":75,"offset":6540},"end":{"line":212,"column":83,"offset":6548},"indent":[]}},{"type":"text","value":"在react reconcile之前的fiber节点","position":{"start":{"line":212,"column":83,"offset":6548},"end":{"line":212,"column":109,"offset":6574},"indent":[]}}],"position":{"start":{"line":212,"column":4,"offset":6469},"end":{"line":212,"column":109,"offset":6574},"indent":[]}},{"type":"html","lang":"javascript","value":"<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n   stateNode<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HTMLSpanElement</span><span class=\"token punctuation\">,</span>\n   type<span class=\"token punctuation\">:</span> <span class=\"token string\">\"span\"</span><span class=\"token punctuation\">,</span>\n   key<span class=\"token punctuation\">:</span> <span class=\"token string\">\"2\"</span><span class=\"token punctuation\">,</span>\n   memoizedProps<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>children<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n   pendingProps<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>children<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n   <span class=\"token operator\">...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","position":{"start":{"line":214,"column":4,"offset":6579},"end":{"line":223,"column":7,"offset":6770},"indent":[4,5,5,5,5,5,5,4,4]}},{"type":"paragraph","children":[{"type":"text","value":"可以看到，","position":{"start":{"line":225,"column":4,"offset":6775},"end":{"line":225,"column":9,"offset":6780},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"memoizedProps","position":{"start":{"line":225,"column":11,"offset":6782},"end":{"line":225,"column":24,"offset":6795},"indent":[]}}],"position":{"start":{"line":225,"column":9,"offset":6780},"end":{"line":225,"column":26,"offset":6797},"indent":[]}},{"type":"text","value":"和","position":{"start":{"line":225,"column":26,"offset":6797},"end":{"line":225,"column":27,"offset":6798},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"pendingProps","position":{"start":{"line":225,"column":29,"offset":6800},"end":{"line":225,"column":41,"offset":6812},"indent":[]}}],"position":{"start":{"line":225,"column":27,"offset":6798},"end":{"line":225,"column":43,"offset":6814},"indent":[]}},{"type":"text","value":"中的","position":{"start":{"line":225,"column":43,"offset":6814},"end":{"line":225,"column":45,"offset":6816},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"children","position":{"start":{"line":225,"column":47,"offset":6818},"end":{"line":225,"column":55,"offset":6826},"indent":[]}}],"position":{"start":{"line":225,"column":45,"offset":6816},"end":{"line":225,"column":57,"offset":6828},"indent":[]}},{"type":"text","value":"是","position":{"start":{"line":225,"column":57,"offset":6828},"end":{"line":225,"column":58,"offset":6829},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"0","position":{"start":{"line":225,"column":60,"offset":6831},"end":{"line":225,"column":61,"offset":6832},"indent":[]}}],"position":{"start":{"line":225,"column":58,"offset":6829},"end":{"line":225,"column":63,"offset":6834},"indent":[]}},{"type":"text","value":"，这里是span元素被render后返回的react元素","position":{"start":{"line":225,"column":63,"offset":6834},"end":{"line":225,"column":91,"offset":6862},"indent":[]}}],"position":{"start":{"line":225,"column":4,"offset":6775},"end":{"line":225,"column":91,"offset":6862},"indent":[]}},{"type":"html","lang":"javascript","value":"<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n   $$<span class=\"token keyword\">typeof</span><span class=\"token punctuation\">:</span> <span class=\"token function\">Symbol</span><span class=\"token punctuation\">(</span>react<span class=\"token punctuation\">.</span>element<span class=\"token punctuation\">)</span>\n   key<span class=\"token punctuation\">:</span> <span class=\"token string\">\"2\"</span>\n   props<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>children<span class=\"token punctuation\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">}</span>\n   ref<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span>\n   type<span class=\"token punctuation\">:</span> <span class=\"token string\">\"span\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","position":{"start":{"line":227,"column":4,"offset":6867},"end":{"line":235,"column":7,"offset":7017},"indent":[4,5,5,5,5,5,4,4]}},{"type":"paragraph","children":[{"type":"text","value":"可以看到，fiber节点中的props和被返回的react元素有不同，在","position":{"start":{"line":237,"column":4,"offset":7022},"end":{"line":237,"column":40,"offset":7058},"indent":[]}},{"type":"link","title":null,"url":"https://github.com/facebook/react/blob/769b1f270e1251d9dbdce0fcbd9e92e502d059b8/packages/react-reconciler/src/ReactFiber.js#L326","children":[{"type":"strong","children":[{"type":"text","value":"createWorkInProgress","position":{"start":{"line":237,"column":43,"offset":7061},"end":{"line":237,"column":63,"offset":7081},"indent":[]}}],"position":{"start":{"line":237,"column":41,"offset":7059},"end":{"line":237,"column":65,"offset":7083},"indent":[]}}],"position":{"start":{"line":237,"column":40,"offset":7058},"end":{"line":237,"column":196,"offset":7214},"indent":[]}},{"type":"text","value":"函数中创建alternate fiber节点，","position":{"start":{"line":237,"column":196,"offset":7214},"end":{"line":237,"column":219,"offset":7237},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"react会从react元素中有更新的属性中复制到fiber节点","position":{"start":{"line":237,"column":221,"offset":7239},"end":{"line":237,"column":253,"offset":7271},"indent":[]}}],"position":{"start":{"line":237,"column":219,"offset":7237},"end":{"line":237,"column":255,"offset":7273},"indent":[]}},{"type":"text","value":"。所以，当react结束","position":{"start":{"line":237,"column":255,"offset":7273},"end":{"line":237,"column":267,"offset":7285},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"ClickCouter","position":{"start":{"line":237,"column":269,"offset":7287},"end":{"line":237,"column":280,"offset":7298},"indent":[]}}],"position":{"start":{"line":237,"column":267,"offset":7285},"end":{"line":237,"column":282,"offset":7300},"indent":[]}},{"type":"text","value":"组件的child reconciliation，","position":{"start":{"line":237,"column":282,"offset":7300},"end":{"line":237,"column":306,"offset":7324},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"span","position":{"start":{"line":237,"column":308,"offset":7326},"end":{"line":237,"column":312,"offset":7330},"indent":[]}}],"position":{"start":{"line":237,"column":306,"offset":7324},"end":{"line":237,"column":314,"offset":7332},"indent":[]}},{"type":"text","value":"的fiber节点会更新","position":{"start":{"line":237,"column":314,"offset":7332},"end":{"line":237,"column":325,"offset":7343},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"pendingProps","position":{"start":{"line":237,"column":327,"offset":7345},"end":{"line":237,"column":339,"offset":7357},"indent":[]}}],"position":{"start":{"line":237,"column":325,"offset":7343},"end":{"line":237,"column":341,"offset":7359},"indent":[]}},{"type":"text","value":"属性。","position":{"start":{"line":237,"column":341,"offset":7359},"end":{"line":237,"column":344,"offset":7362},"indent":[]}}],"position":{"start":{"line":237,"column":4,"offset":7022},"end":{"line":237,"column":344,"offset":7362},"indent":[]}},{"type":"html","lang":"javascript","value":"<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n   stateNode<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HTMLSpanElement</span><span class=\"token punctuation\">,</span>\n   type<span class=\"token punctuation\">:</span> <span class=\"token string\">\"span\"</span><span class=\"token punctuation\">,</span>\n   key<span class=\"token punctuation\">:</span> <span class=\"token string\">\"2\"</span><span class=\"token punctuation\">,</span>\n   memoizedProps<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>children<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n   pendingProps<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>children<span class=\"token punctuation\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n   <span class=\"token operator\">...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","position":{"start":{"line":239,"column":4,"offset":7367},"end":{"line":248,"column":7,"offset":7558},"indent":[4,5,5,5,5,5,5,4,4]}},{"type":"paragraph","children":[{"type":"text","value":"当react执行span fiber节点工作时，会将pendingProps复制到","position":{"start":{"line":250,"column":4,"offset":7563},"end":{"line":250,"column":45,"offset":7604},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"memoizedProps","position":{"start":{"line":250,"column":47,"offset":7606},"end":{"line":250,"column":60,"offset":7619},"indent":[]}}],"position":{"start":{"line":250,"column":45,"offset":7604},"end":{"line":250,"column":62,"offset":7621},"indent":[]}},{"type":"text","value":"中并添加一个effects去更新DOM。","position":{"start":{"line":250,"column":62,"offset":7621},"end":{"line":250,"column":82,"offset":7641},"indent":[]}}],"position":{"start":{"line":250,"column":4,"offset":7563},"end":{"line":250,"column":82,"offset":7641},"indent":[]}}],"position":{"start":{"line":212,"column":1,"offset":6466},"end":{"line":252,"column":4,"offset":7646},"indent":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]}}],"position":{"start":{"line":210,"column":1,"offset":6312},"end":{"line":252,"column":4,"offset":7646},"indent":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"   这就是render阶段react在","position":{"start":{"line":254,"column":1,"offset":7648},"end":{"line":254,"column":21,"offset":7668},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"ClickCounter","position":{"start":{"line":254,"column":23,"offset":7670},"end":{"line":254,"column":35,"offset":7682},"indent":[]}}],"position":{"start":{"line":254,"column":21,"offset":7668},"end":{"line":254,"column":37,"offset":7684},"indent":[]}},{"type":"text","value":" fiber节点上的工作。因为button是ClickCounter组件的第一个孩子，他会被分配到","position":{"start":{"line":254,"column":37,"offset":7684},"end":{"line":254,"column":86,"offset":7733},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"nextUnitOfWork","position":{"start":{"line":254,"column":88,"offset":7735},"end":{"line":254,"column":102,"offset":7749},"indent":[]}}],"position":{"start":{"line":254,"column":86,"offset":7733},"end":{"line":254,"column":104,"offset":7751},"indent":[]}},{"type":"text","value":"，且他没什么卵事要干，所以react会移动到他的兄弟节点—span。","position":{"start":{"line":254,"column":104,"offset":7751},"end":{"line":254,"column":139,"offset":7786},"indent":[]}}],"position":{"start":{"line":254,"column":1,"offset":7648},"end":{"line":254,"column":139,"offset":7786},"indent":[]}},{"type":"heading","depth":3,"children":[{"type":"text","value":"Processing updates for the Span fiber","position":{"start":{"line":260,"column":5,"offset":7796},"end":{"line":260,"column":42,"offset":7833},"indent":[]}}],"position":{"start":{"line":260,"column":1,"offset":7792},"end":{"line":260,"column":42,"offset":7833},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"与","position":{"start":{"line":262,"column":1,"offset":7835},"end":{"line":262,"column":2,"offset":7836},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"ClickCounter","position":{"start":{"line":262,"column":4,"offset":7838},"end":{"line":262,"column":16,"offset":7850},"indent":[]}}],"position":{"start":{"line":262,"column":2,"offset":7836},"end":{"line":262,"column":18,"offset":7852},"indent":[]}},{"type":"text","value":"相似，从","position":{"start":{"line":262,"column":18,"offset":7852},"end":{"line":262,"column":22,"offset":7856},"indent":[]}},{"type":"link","title":null,"url":"https://github.com/facebook/react/blob/cbbc2b6c4d0d8519145560bd8183ecde55168b12/packages/react-reconciler/src/ReactFiberBeginWork.js#L1489","children":[{"type":"text","value":"beginWork","position":{"start":{"line":262,"column":23,"offset":7857},"end":{"line":262,"column":32,"offset":7866},"indent":[]}}],"position":{"start":{"line":262,"column":22,"offset":7856},"end":{"line":262,"column":173,"offset":8007},"indent":[]}},{"type":"text","value":"函数开始。因为","position":{"start":{"line":262,"column":173,"offset":8007},"end":{"line":262,"column":180,"offset":8014},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"span","position":{"start":{"line":262,"column":182,"offset":8016},"end":{"line":262,"column":186,"offset":8020},"indent":[]}}],"position":{"start":{"line":262,"column":180,"offset":8014},"end":{"line":262,"column":188,"offset":8022},"indent":[]}},{"type":"text","value":"节点是","position":{"start":{"line":262,"column":188,"offset":8022},"end":{"line":262,"column":191,"offset":8025},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"HostComponent","position":{"start":{"line":262,"column":193,"offset":8027},"end":{"line":262,"column":206,"offset":8040},"indent":[]}}],"position":{"start":{"line":262,"column":191,"offset":8025},"end":{"line":262,"column":208,"offset":8042},"indent":[]}},{"type":"text","value":"类型，所以：","position":{"start":{"line":262,"column":208,"offset":8042},"end":{"line":262,"column":214,"offset":8048},"indent":[]}}],"position":{"start":{"line":262,"column":1,"offset":7835},"end":{"line":262,"column":214,"offset":8048},"indent":[]}},{"type":"html","lang":"javascript","value":"<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">beginWork</span><span class=\"token punctuation\">(</span>current$$<span class=\"token number\">1</span><span class=\"token punctuation\">,</span> workInProgress<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token operator\">...</span>\n    <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">.</span>tag<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">case</span> FunctionalComponent<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span><span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">case</span> ClassComponent<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span><span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">case</span> HostComponent<span class=\"token punctuation\">:</span>\n          <span class=\"token keyword\">return</span> <span class=\"token function\">updateHostComponent</span><span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">,</span> workInProgress<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">case</span> <span class=\"token operator\">...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","position":{"start":{"line":264,"column":1,"offset":8050},"end":{"line":274,"column":5,"offset":8355},"indent":[1,1,1,1,1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"在","position":{"start":{"line":276,"column":1,"offset":8357},"end":{"line":276,"column":2,"offset":8358},"indent":[]}},{"type":"link","title":null,"url":"https://github.com/facebook/react/blob/cbbc2b6c4d0d8519145560bd8183ecde55168b12/packages/react-reconciler/src/ReactFiberBeginWork.js#L686","children":[{"type":"text","value":"updateHostComponent","position":{"start":{"line":276,"column":3,"offset":8359},"end":{"line":276,"column":22,"offset":8378},"indent":[]}}],"position":{"start":{"line":276,"column":2,"offset":8358},"end":{"line":276,"column":162,"offset":8518},"indent":[]}},{"type":"text","value":"结束。可以与class组件调用的","position":{"start":{"line":276,"column":162,"offset":8518},"end":{"line":276,"column":178,"offset":8534},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"updateClassComponent","position":{"start":{"line":276,"column":180,"offset":8536},"end":{"line":276,"column":200,"offset":8556},"indent":[]}}],"position":{"start":{"line":276,"column":178,"offset":8534},"end":{"line":276,"column":202,"offset":8558},"indent":[]}},{"type":"text","value":"对比。对于函数式组件是","position":{"start":{"line":276,"column":202,"offset":8558},"end":{"line":276,"column":213,"offset":8569},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"updateFunctionComponent","position":{"start":{"line":276,"column":215,"offset":8571},"end":{"line":276,"column":238,"offset":8594},"indent":[]}}],"position":{"start":{"line":276,"column":213,"offset":8569},"end":{"line":276,"column":240,"offset":8596},"indent":[]}},{"type":"text","value":"。你可以在","position":{"start":{"line":276,"column":240,"offset":8596},"end":{"line":276,"column":245,"offset":8601},"indent":[]}},{"type":"link","title":null,"url":"https://github.com/facebook/react/blob/1034e26fe5e42ba07492a736da7bdf5bf2108bc6/packages/react-reconciler/src/ReactFiberBeginWork.js","children":[{"type":"strong","children":[{"type":"text","value":"ReactFiberBeginWork.js","position":{"start":{"line":276,"column":248,"offset":8604},"end":{"line":276,"column":270,"offset":8626},"indent":[]}}],"position":{"start":{"line":276,"column":246,"offset":8602},"end":{"line":276,"column":272,"offset":8628},"indent":[]}}],"position":{"start":{"line":276,"column":245,"offset":8601},"end":{"line":276,"column":407,"offset":8763},"indent":[]}},{"type":"text","value":"中找到所有这些函数。","position":{"start":{"line":276,"column":407,"offset":8763},"end":{"line":276,"column":417,"offset":8773},"indent":[]}}],"position":{"start":{"line":276,"column":1,"offset":8357},"end":{"line":276,"column":417,"offset":8773},"indent":[]}},{"type":"heading","depth":3,"children":[{"type":"text","value":"Reconciling children for the span fiber","position":{"start":{"line":278,"column":5,"offset":8779},"end":{"line":278,"column":44,"offset":8818},"indent":[]}}],"position":{"start":{"line":278,"column":1,"offset":8775},"end":{"line":278,"column":44,"offset":8818},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"在我们的例子中，span节点的","position":{"start":{"line":280,"column":1,"offset":8820},"end":{"line":280,"column":16,"offset":8835},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"updateHostComponent","position":{"start":{"line":280,"column":18,"offset":8837},"end":{"line":280,"column":37,"offset":8856},"indent":[]}}],"position":{"start":{"line":280,"column":16,"offset":8835},"end":{"line":280,"column":39,"offset":8858},"indent":[]}},{"type":"text","value":"中没有特别重要的事情发生。","position":{"start":{"line":280,"column":39,"offset":8858},"end":{"line":280,"column":52,"offset":8871},"indent":[]}}],"position":{"start":{"line":280,"column":1,"offset":8820},"end":{"line":280,"column":52,"offset":8871},"indent":[]}},{"type":"heading","depth":3,"children":[{"type":"text","value":"Completing work for the Span Fiber node","position":{"start":{"line":282,"column":5,"offset":8877},"end":{"line":282,"column":44,"offset":8916},"indent":[]}}],"position":{"start":{"line":282,"column":1,"offset":8873},"end":{"line":282,"column":44,"offset":8916},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"当","position":{"start":{"line":284,"column":1,"offset":8918},"end":{"line":284,"column":2,"offset":8919},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"beginWork","position":{"start":{"line":284,"column":4,"offset":8921},"end":{"line":284,"column":13,"offset":8930},"indent":[]}}],"position":{"start":{"line":284,"column":2,"offset":8919},"end":{"line":284,"column":15,"offset":8932},"indent":[]}},{"type":"text","value":"结束后，会进入","position":{"start":{"line":284,"column":15,"offset":8932},"end":{"line":284,"column":22,"offset":8939},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"completeWork","position":{"start":{"line":284,"column":24,"offset":8941},"end":{"line":284,"column":36,"offset":8953},"indent":[]}}],"position":{"start":{"line":284,"column":22,"offset":8939},"end":{"line":284,"column":38,"offset":8955},"indent":[]}},{"type":"text","value":"。不过在这之前，react需要更新span fiber节点上的","position":{"start":{"line":284,"column":38,"offset":8955},"end":{"line":284,"column":69,"offset":8986},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"memoizedProps","position":{"start":{"line":284,"column":71,"offset":8988},"end":{"line":284,"column":84,"offset":9001},"indent":[]}}],"position":{"start":{"line":284,"column":69,"offset":8986},"end":{"line":284,"column":86,"offset":9003},"indent":[]}},{"type":"text","value":"，你可能还记得当","position":{"start":{"line":284,"column":86,"offset":9003},"end":{"line":284,"column":94,"offset":9011},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"ClickCounter","position":{"start":{"line":284,"column":96,"offset":9013},"end":{"line":284,"column":108,"offset":9025},"indent":[]}}],"position":{"start":{"line":284,"column":94,"offset":9011},"end":{"line":284,"column":110,"offset":9027},"indent":[]}},{"type":"text","value":"上reconciling children时，react更新了span fiber节点的","position":{"start":{"line":284,"column":110,"offset":9027},"end":{"line":284,"column":154,"offset":9071},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"pendingProps","position":{"start":{"line":284,"column":156,"offset":9073},"end":{"line":284,"column":168,"offset":9085},"indent":[]}}],"position":{"start":{"line":284,"column":154,"offset":9071},"end":{"line":284,"column":170,"offset":9087},"indent":[]}}],"position":{"start":{"line":284,"column":1,"offset":8918},"end":{"line":284,"column":170,"offset":9087},"indent":[]}},{"type":"html","lang":"javascript","value":"<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">//这是之前的</span>\n<span class=\"token punctuation\">{</span>\n    stateNode<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HTMLSpanElement</span><span class=\"token punctuation\">,</span>\n    type<span class=\"token punctuation\">:</span> <span class=\"token string\">\"span\"</span><span class=\"token punctuation\">,</span>\n    key<span class=\"token punctuation\">:</span> <span class=\"token string\">\"2\"</span><span class=\"token punctuation\">,</span>\n    memoizedProps<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>children<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    pendingProps<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>children<span class=\"token punctuation\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token operator\">...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","position":{"start":{"line":286,"column":1,"offset":9089},"end":{"line":296,"column":4,"offset":9261},"indent":[1,1,1,1,1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"当","position":{"start":{"line":298,"column":1,"offset":9263},"end":{"line":298,"column":2,"offset":9264},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"span","position":{"start":{"line":298,"column":4,"offset":9266},"end":{"line":298,"column":8,"offset":9270},"indent":[]}}],"position":{"start":{"line":298,"column":2,"offset":9264},"end":{"line":298,"column":10,"offset":9272},"indent":[]}},{"type":"text","value":"的fiber","position":{"start":{"line":298,"column":10,"offset":9272},"end":{"line":298,"column":16,"offset":9278},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"beginWork","position":{"start":{"line":298,"column":18,"offset":9280},"end":{"line":298,"column":27,"offset":9289},"indent":[]}}],"position":{"start":{"line":298,"column":16,"offset":9278},"end":{"line":298,"column":29,"offset":9291},"indent":[]}},{"type":"text","value":"完成后，react更新pendingProps以匹配memoizedProps","position":{"start":{"line":298,"column":29,"offset":9291},"end":{"line":298,"column":68,"offset":9330},"indent":[]}}],"position":{"start":{"line":298,"column":1,"offset":9263},"end":{"line":298,"column":68,"offset":9330},"indent":[]}},{"type":"html","lang":"javascript","value":"<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">performUnitOfWork</span><span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token operator\">...</span>\n    next <span class=\"token operator\">=</span> <span class=\"token function\">beginWork</span><span class=\"token punctuation\">(</span>current$$<span class=\"token number\">1</span><span class=\"token punctuation\">,</span> workInProgress<span class=\"token punctuation\">,</span> nextRenderExpirationTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    workInProgress<span class=\"token punctuation\">.</span>memoizedProps <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>pendingProps<span class=\"token punctuation\">;</span>\n    <span class=\"token operator\">...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","position":{"start":{"line":300,"column":1,"offset":9332},"end":{"line":307,"column":4,"offset":9552},"indent":[1,1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"然后它调用completeWork函数，它基本上是一个类似于我们在beginWork中看到的大转换语句","position":{"start":{"line":309,"column":1,"offset":9554},"end":{"line":309,"column":52,"offset":9605},"indent":[]}}],"position":{"start":{"line":309,"column":1,"offset":9554},"end":{"line":309,"column":52,"offset":9605},"indent":[]}},{"type":"html","lang":"javascript","value":"<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">completeWork</span><span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">,</span> workInProgress<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token operator\">...</span>\n    <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">.</span>tag<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">case</span> FunctionComponent<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span><span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">case</span> ClassComponent<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span><span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">case</span> HostComponent<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token operator\">...</span>\n            <span class=\"token function\">updateHostComponent</span><span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">,</span> workInProgress<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">case</span> <span class=\"token operator\">...</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","position":{"start":{"line":311,"column":1,"offset":9607},"end":{"line":325,"column":4,"offset":9938},"indent":[1,1,1,1,1,1,1,1,1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"由于我们的span Fiber节点是HostComponent，因此它运行","position":{"start":{"line":327,"column":1,"offset":9940},"end":{"line":327,"column":38,"offset":9977},"indent":[]}},{"type":"link","title":null,"url":"https://github.com/facebook/react/blob/cbbc2b6c4d0d8519145560bd8183ecde55168b12/packages/react-reconciler/src/ReactFiberBeginWork.js#L686","children":[{"type":"strong","children":[{"type":"text","value":"updateHostComponent","position":{"start":{"line":327,"column":41,"offset":9980},"end":{"line":327,"column":60,"offset":9999},"indent":[]}}],"position":{"start":{"line":327,"column":39,"offset":9978},"end":{"line":327,"column":62,"offset":10001},"indent":[]}}],"position":{"start":{"line":327,"column":38,"offset":9977},"end":{"line":327,"column":202,"offset":10141},"indent":[]}},{"type":"text","value":"函数。在这个函数中，React基本上执行以下操作：","position":{"start":{"line":327,"column":202,"offset":10141},"end":{"line":327,"column":227,"offset":10166},"indent":[]}}],"position":{"start":{"line":327,"column":1,"offset":9940},"end":{"line":327,"column":227,"offset":10166},"indent":[]}},{"type":"list","ordered":false,"start":null,"loose":false,"children":[{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"准备DOM更新","position":{"start":{"line":329,"column":3,"offset":10170},"end":{"line":329,"column":10,"offset":10177},"indent":[]}}],"position":{"start":{"line":329,"column":3,"offset":10170},"end":{"line":329,"column":10,"offset":10177},"indent":[]}}],"position":{"start":{"line":329,"column":1,"offset":10168},"end":{"line":329,"column":10,"offset":10177},"indent":[]}},{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"将这些更新放到span fiber节点的updateQueue","position":{"start":{"line":330,"column":3,"offset":10180},"end":{"line":330,"column":34,"offset":10211},"indent":[]}}],"position":{"start":{"line":330,"column":3,"offset":10180},"end":{"line":330,"column":34,"offset":10211},"indent":[]}}],"position":{"start":{"line":330,"column":1,"offset":10178},"end":{"line":330,"column":34,"offset":10211},"indent":[]}},{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"将这些effect应用到更新DOM上","position":{"start":{"line":331,"column":3,"offset":10214},"end":{"line":331,"column":21,"offset":10232},"indent":[]}}],"position":{"start":{"line":331,"column":3,"offset":10214},"end":{"line":331,"column":21,"offset":10232},"indent":[]}}],"position":{"start":{"line":331,"column":1,"offset":10212},"end":{"line":331,"column":21,"offset":10232},"indent":[]}}],"position":{"start":{"line":329,"column":1,"offset":10168},"end":{"line":331,"column":21,"offset":10232},"indent":[1,1]}},{"type":"paragraph","children":[{"type":"text","value":"在执行这些操作之前，span Fiber节点如下所示：","position":{"start":{"line":333,"column":1,"offset":10234},"end":{"line":333,"column":28,"offset":10261},"indent":[]}}],"position":{"start":{"line":333,"column":1,"offset":10234},"end":{"line":333,"column":28,"offset":10261},"indent":[]}},{"type":"html","lang":"javascript","value":"<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n    stateNode<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HTMLSpanElement</span><span class=\"token punctuation\">,</span>\n    type<span class=\"token punctuation\">:</span> <span class=\"token string\">\"span\"</span><span class=\"token punctuation\">,</span>\n    effectTag<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span>\n    updateQueue<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span>\n    <span class=\"token operator\">...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","position":{"start":{"line":335,"column":1,"offset":10263},"end":{"line":343,"column":4,"offset":10385},"indent":[1,1,1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"当工作完成时，它看起来像这样：","position":{"start":{"line":345,"column":1,"offset":10387},"end":{"line":345,"column":16,"offset":10402},"indent":[]}}],"position":{"start":{"line":345,"column":1,"offset":10387},"end":{"line":345,"column":16,"offset":10402},"indent":[]}},{"type":"html","lang":"javascript","value":"<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n    stateNode<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HTMLSpanElement</span><span class=\"token punctuation\">,</span>\n    type<span class=\"token punctuation\">:</span> <span class=\"token string\">\"span\"</span><span class=\"token punctuation\">,</span>\n    effectTag<span class=\"token punctuation\">:</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span>\n    updateQueue<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"children\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"1\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token operator\">...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","position":{"start":{"line":347,"column":1,"offset":10404},"end":{"line":355,"column":4,"offset":10541},"indent":[1,1,1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"​\t注意effectTag和updateQueue字段的区别。它不再是0，它的值是4.在二进制中，这是100，这意味着第三位被设置，这是","position":{"start":{"line":357,"column":1,"offset":10543},"end":{"line":357,"column":69,"offset":10611},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"update","position":{"start":{"line":357,"column":71,"offset":10613},"end":{"line":357,"column":77,"offset":10619},"indent":[]}}],"position":{"start":{"line":357,"column":69,"offset":10611},"end":{"line":357,"column":79,"offset":10621},"indent":[]}},{"type":"text","value":" side-effect的标志位。这是react需要在接下来的commit阶段对这个节点仅需的工作。","position":{"start":{"line":357,"column":79,"offset":10621},"end":{"line":357,"column":129,"offset":10671},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"updateQueue","position":{"start":{"line":357,"column":131,"offset":10673},"end":{"line":357,"column":142,"offset":10684},"indent":[]}}],"position":{"start":{"line":357,"column":129,"offset":10671},"end":{"line":357,"column":144,"offset":10686},"indent":[]}},{"type":"text","value":"字段保存将用于更新的有效payload。 ","position":{"start":{"line":357,"column":144,"offset":10686},"end":{"line":357,"column":165,"offset":10707},"indent":[]}}],"position":{"start":{"line":357,"column":1,"offset":10543},"end":{"line":357,"column":165,"offset":10707},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"​\t当react处理完","position":{"start":{"line":359,"column":1,"offset":10709},"end":{"line":359,"column":12,"offset":10720},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"ClickCounter","position":{"start":{"line":359,"column":14,"offset":10722},"end":{"line":359,"column":26,"offset":10734},"indent":[]}}],"position":{"start":{"line":359,"column":12,"offset":10720},"end":{"line":359,"column":28,"offset":10736},"indent":[]}},{"type":"text","value":"和他的孩子，render阶段就结束了。它现在可以将完成的alternate tree分配给FiberRoot上的finishedWork属性。这是需要刷新到屏幕的新树。它可以在渲染阶段后立即处理，也可以在浏览器给出React时间后再处理。","position":{"start":{"line":359,"column":28,"offset":10736},"end":{"line":359,"column":147,"offset":10855},"indent":[]}}],"position":{"start":{"line":359,"column":1,"offset":10709},"end":{"line":359,"column":147,"offset":10855},"indent":[]}},{"type":"heading","depth":3,"children":[{"type":"text","value":"Effects list","position":{"start":{"line":361,"column":5,"offset":10861},"end":{"line":361,"column":17,"offset":10873},"indent":[]}}],"position":{"start":{"line":361,"column":1,"offset":10857},"end":{"line":361,"column":17,"offset":10873},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"​\t在我们的例子中，因为span节点和ClickCounter组件有side effects，react会将span的fiber节点连接到HostFiber的firstEffect属性。react会在","position":{"start":{"line":363,"column":1,"offset":10875},"end":{"line":363,"column":101,"offset":10975},"indent":[]}},{"type":"link","title":null,"url":"https://github.com/facebook/react/blob/d5e1bf07d086e4fc1998653331adecddcd0f5274/packages/react-reconciler/src/ReactFiberScheduler.js#L999","children":[{"type":"strong","children":[{"type":"text","value":"compliteUnitOfWork","position":{"start":{"line":363,"column":104,"offset":10978},"end":{"line":363,"column":122,"offset":10996},"indent":[]}}],"position":{"start":{"line":363,"column":102,"offset":10976},"end":{"line":363,"column":124,"offset":10998},"indent":[]}}],"position":{"start":{"line":363,"column":101,"offset":10975},"end":{"line":363,"column":264,"offset":11138},"indent":[]}},{"type":"text","value":"函数构建effects list，以下是具有更新span节点和ClickCounter上的钩子效果的fiber tree：","position":{"start":{"line":363,"column":264,"offset":11138},"end":{"line":363,"column":325,"offset":11199},"indent":[]}}],"position":{"start":{"line":363,"column":1,"offset":10875},"end":{"line":363,"column":325,"offset":11199},"indent":[]}},{"type":"paragraph","children":[{"type":"image","title":null,"url":"http://pjpqjxkf6.bkt.clouddn.com/1_TRmFSeuOuWlY3HXh86cvDA.png","alt":null,"position":{"start":{"line":365,"column":1,"offset":11201},"end":{"line":365,"column":67,"offset":11267},"indent":[]}}],"position":{"start":{"line":365,"column":1,"offset":11201},"end":{"line":365,"column":67,"offset":11267},"indent":[]}},{"type":"heading","depth":2,"children":[{"type":"text","value":"commit阶段","position":{"start":{"line":367,"column":4,"offset":11272},"end":{"line":367,"column":12,"offset":11280},"indent":[]}}],"position":{"start":{"line":367,"column":1,"offset":11269},"end":{"line":367,"column":12,"offset":11280},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"​\tcommit阶段是react更新DOM和调用cDU生命周期。为了实现，react会遍历render阶段构建的effects list并应用他们。","position":{"start":{"line":369,"column":1,"offset":11282},"end":{"line":369,"column":75,"offset":11356},"indent":[]}}],"position":{"start":{"line":369,"column":1,"offset":11282},"end":{"line":369,"column":75,"offset":11356},"indent":[]}},{"type":"html","lang":"javascript","value":"<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span> type<span class=\"token punctuation\">:</span> ClickCounter<span class=\"token punctuation\">,</span> effectTag<span class=\"token punctuation\">:</span> <span class=\"token number\">5</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">{</span> type<span class=\"token punctuation\">:</span> <span class=\"token string\">'span'</span><span class=\"token punctuation\">,</span> effectTag<span class=\"token punctuation\">:</span> <span class=\"token number\">4</span> <span class=\"token punctuation\">}</span></code></pre></div>","position":{"start":{"line":371,"column":1,"offset":11358},"end":{"line":374,"column":4,"offset":11443},"indent":[1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"​\tClickCouter的effect tag是5（二进制是101），定义了","position":{"start":{"line":376,"column":1,"offset":11445},"end":{"line":376,"column":40,"offset":11484},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"Update","position":{"start":{"line":376,"column":42,"offset":11486},"end":{"line":376,"column":48,"offset":11492},"indent":[]}}],"position":{"start":{"line":376,"column":40,"offset":11484},"end":{"line":376,"column":50,"offset":11494},"indent":[]}},{"type":"text","value":"，对于class组件来说基本上是转换","position":{"start":{"line":376,"column":50,"offset":11494},"end":{"line":376,"column":68,"offset":11512},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"componentDidUpdate","position":{"start":{"line":376,"column":70,"offset":11514},"end":{"line":376,"column":88,"offset":11532},"indent":[]}}],"position":{"start":{"line":376,"column":68,"offset":11512},"end":{"line":376,"column":90,"offset":11534},"indent":[]}},{"type":"text","value":"，二进制的最后一位被设置意味着这个fiber节点在","position":{"start":{"line":376,"column":90,"offset":11534},"end":{"line":376,"column":115,"offset":11559},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"render","position":{"start":{"line":376,"column":117,"offset":11561},"end":{"line":376,"column":123,"offset":11567},"indent":[]}}],"position":{"start":{"line":376,"column":115,"offset":11559},"end":{"line":376,"column":125,"offset":11569},"indent":[]}},{"type":"text","value":"阶段的所有工作已经完成。","position":{"start":{"line":376,"column":125,"offset":11569},"end":{"line":376,"column":137,"offset":11581},"indent":[]}}],"position":{"start":{"line":376,"column":1,"offset":11445},"end":{"line":376,"column":137,"offset":11581},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"​\tspan的effect tag是4（二进制100），定义了 update，对于host组件来说是DOM更新。在span元素的情况下，react会更新元素的","position":{"start":{"line":378,"column":1,"offset":11583},"end":{"line":378,"column":80,"offset":11662},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"textContent","position":{"start":{"line":378,"column":82,"offset":11664},"end":{"line":378,"column":93,"offset":11675},"indent":[]}}],"position":{"start":{"line":378,"column":80,"offset":11662},"end":{"line":378,"column":95,"offset":11677},"indent":[]}},{"type":"text","value":"。","position":{"start":{"line":378,"column":95,"offset":11677},"end":{"line":378,"column":96,"offset":11678},"indent":[]}}],"position":{"start":{"line":378,"column":1,"offset":11583},"end":{"line":378,"column":96,"offset":11678},"indent":[]}},{"type":"heading","depth":3,"children":[{"type":"text","value":"Applying effects","position":{"start":{"line":380,"column":5,"offset":11684},"end":{"line":380,"column":21,"offset":11700},"indent":[]}}],"position":{"start":{"line":380,"column":1,"offset":11680},"end":{"line":380,"column":21,"offset":11700},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"​\t让我们看看react是如何应用这些effects的，","position":{"start":{"line":382,"column":1,"offset":11702},"end":{"line":382,"column":29,"offset":11730},"indent":[]}},{"type":"link","title":null,"url":"https://github.com/facebook/react/blob/95a313ec0b957f71798a69d8e83408f40e76765b/packages/react-reconciler/src/ReactFiberScheduler.js#L523","children":[{"type":"strong","children":[{"type":"text","value":"commitRoot","position":{"start":{"line":382,"column":32,"offset":11733},"end":{"line":382,"column":42,"offset":11743},"indent":[]}}],"position":{"start":{"line":382,"column":30,"offset":11731},"end":{"line":382,"column":44,"offset":11745},"indent":[]}}],"position":{"start":{"line":382,"column":29,"offset":11730},"end":{"line":382,"column":184,"offset":11885},"indent":[]}},{"type":"text","value":"函数，包含了三个子函数：","position":{"start":{"line":382,"column":184,"offset":11885},"end":{"line":382,"column":196,"offset":11897},"indent":[]}}],"position":{"start":{"line":382,"column":1,"offset":11702},"end":{"line":382,"column":196,"offset":11897},"indent":[]}},{"type":"html","lang":"javascript","value":"<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">commitRoot</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">,</span> finishedWork<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">commitBeforeMutationLifecycles</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token function\">commitAllHostEffects</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    root<span class=\"token punctuation\">.</span>current <span class=\"token operator\">=</span> finishedWork<span class=\"token punctuation\">;</span>\n    <span class=\"token function\">commitAllLifeCycles</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","position":{"start":{"line":384,"column":1,"offset":11899},"end":{"line":391,"column":4,"offset":12085},"indent":[1,1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":" \t每一个子函数都会遍历effecys list并检查effects的类型。当它找到与函数目的相关的效果时，它会应用它。在我们的例子中，commitRoot会调用","position":{"start":{"line":393,"column":1,"offset":12087},"end":{"line":393,"column":82,"offset":12168},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"ClickCounter","position":{"start":{"line":393,"column":84,"offset":12170},"end":{"line":393,"column":96,"offset":12182},"indent":[]}}],"position":{"start":{"line":393,"column":82,"offset":12168},"end":{"line":393,"column":98,"offset":12184},"indent":[]}},{"type":"text","value":"的","position":{"start":{"line":393,"column":98,"offset":12184},"end":{"line":393,"column":99,"offset":12185},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"cDU","position":{"start":{"line":393,"column":101,"offset":12187},"end":{"line":393,"column":104,"offset":12190},"indent":[]}}],"position":{"start":{"line":393,"column":99,"offset":12185},"end":{"line":393,"column":106,"offset":12192},"indent":[]}},{"type":"text","value":"和更新","position":{"start":{"line":393,"column":106,"offset":12192},"end":{"line":393,"column":109,"offset":12195},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"span","position":{"start":{"line":393,"column":111,"offset":12197},"end":{"line":393,"column":115,"offset":12201},"indent":[]}}],"position":{"start":{"line":393,"column":109,"offset":12195},"end":{"line":393,"column":117,"offset":12203},"indent":[]}},{"type":"text","value":"元素的文本。","position":{"start":{"line":393,"column":117,"offset":12203},"end":{"line":393,"column":123,"offset":12209},"indent":[]}}],"position":{"start":{"line":393,"column":1,"offset":12087},"end":{"line":393,"column":123,"offset":12209},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"​\t第一个函数","position":{"start":{"line":395,"column":1,"offset":12211},"end":{"line":395,"column":8,"offset":12218},"indent":[]}},{"type":"link","title":null,"url":"https://github.com/facebook/react/blob/fefa1269e2a67fa5ef0992d5cc1d6114b7948b7e/packages/react-reconciler/src/ReactFiberCommitWork.js#L183","children":[{"type":"text","value":"commitBeforeMutationLifeCycles","position":{"start":{"line":395,"column":9,"offset":12219},"end":{"line":395,"column":39,"offset":12249},"indent":[]}}],"position":{"start":{"line":395,"column":8,"offset":12218},"end":{"line":395,"column":180,"offset":12390},"indent":[]}},{"type":"text","value":"会查找","position":{"start":{"line":395,"column":180,"offset":12390},"end":{"line":395,"column":183,"offset":12393},"indent":[]}},{"type":"link","title":null,"url":"https://github.com/facebook/react/blob/b87aabdfe1b7461e7331abb3601d9e6bb27544bc/packages/shared/ReactSideEffectTags.js#L25","children":[{"type":"strong","children":[{"type":"text","value":"Snapshot","position":{"start":{"line":395,"column":186,"offset":12396},"end":{"line":395,"column":194,"offset":12404},"indent":[]}}],"position":{"start":{"line":395,"column":184,"offset":12394},"end":{"line":395,"column":196,"offset":12406},"indent":[]}}],"position":{"start":{"line":395,"column":183,"offset":12393},"end":{"line":395,"column":321,"offset":12531},"indent":[]}},{"type":"text","value":" effect并调用","position":{"start":{"line":395,"column":321,"offset":12531},"end":{"line":395,"column":331,"offset":12541},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"getSnapshotBeforeUpdate","position":{"start":{"line":395,"column":333,"offset":12543},"end":{"line":395,"column":356,"offset":12566},"indent":[]}}],"position":{"start":{"line":395,"column":331,"offset":12541},"end":{"line":395,"column":358,"offset":12568},"indent":[]}},{"type":"text","value":"方法。不过我们的","position":{"start":{"line":395,"column":358,"offset":12568},"end":{"line":395,"column":366,"offset":12576},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"ClickCouter","position":{"start":{"line":395,"column":368,"offset":12578},"end":{"line":395,"column":379,"offset":12589},"indent":[]}}],"position":{"start":{"line":395,"column":366,"offset":12576},"end":{"line":395,"column":381,"offset":12591},"indent":[]}},{"type":"text","value":"组件没有实现这个方法，react不会在","position":{"start":{"line":395,"column":381,"offset":12591},"end":{"line":395,"column":400,"offset":12610},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"render","position":{"start":{"line":395,"column":402,"offset":12612},"end":{"line":395,"column":408,"offset":12618},"indent":[]}}],"position":{"start":{"line":395,"column":400,"offset":12610},"end":{"line":395,"column":410,"offset":12620},"indent":[]}},{"type":"text","value":"阶段中添加这个effect，所以在我们的例子中，这个函数不起作用。","position":{"start":{"line":395,"column":410,"offset":12620},"end":{"line":395,"column":443,"offset":12653},"indent":[]}}],"position":{"start":{"line":395,"column":1,"offset":12211},"end":{"line":395,"column":443,"offset":12653},"indent":[]}},{"type":"heading","depth":3,"children":[{"type":"text","value":"DOM updates","position":{"start":{"line":397,"column":5,"offset":12659},"end":{"line":397,"column":16,"offset":12670},"indent":[]}}],"position":{"start":{"line":397,"column":1,"offset":12655},"end":{"line":397,"column":16,"offset":12670},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"​\t下一步，react会执行","position":{"start":{"line":399,"column":1,"offset":12672},"end":{"line":399,"column":15,"offset":12686},"indent":[]}},{"type":"link","title":null,"url":"https://github.com/facebook/react/blob/95a313ec0b957f71798a69d8e83408f40e76765b/packages/react-reconciler/src/ReactFiberScheduler.js#L376","children":[{"type":"strong","children":[{"type":"text","value":"commitAllHostEffects","position":{"start":{"line":399,"column":18,"offset":12689},"end":{"line":399,"column":38,"offset":12709},"indent":[]}}],"position":{"start":{"line":399,"column":16,"offset":12687},"end":{"line":399,"column":40,"offset":12711},"indent":[]}}],"position":{"start":{"line":399,"column":15,"offset":12686},"end":{"line":399,"column":180,"offset":12851},"indent":[]}},{"type":"text","value":"函数，在这个函数中React会将","position":{"start":{"line":399,"column":180,"offset":12851},"end":{"line":399,"column":196,"offset":12867},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"span","position":{"start":{"line":399,"column":198,"offset":12869},"end":{"line":399,"column":202,"offset":12873},"indent":[]}}],"position":{"start":{"line":399,"column":196,"offset":12867},"end":{"line":399,"column":204,"offset":12875},"indent":[]}},{"type":"text","value":"元素的文本从0改变到1，而ClickCounter组件则不受任何影响因为class组件对应的节点没有任何DOM更新。","position":{"start":{"line":399,"column":204,"offset":12875},"end":{"line":399,"column":262,"offset":12933},"indent":[]}}],"position":{"start":{"line":399,"column":1,"offset":12672},"end":{"line":399,"column":262,"offset":12933},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"​\t该函数的要点是它选择正确的效果类型并应用相应的操作。在我们的例子中，我们需要更新span元素的文本，所以我们在这里采用","position":{"start":{"line":401,"column":1,"offset":12935},"end":{"line":401,"column":62,"offset":12996},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"Update","position":{"start":{"line":401,"column":64,"offset":12998},"end":{"line":401,"column":70,"offset":13004},"indent":[]}}],"position":{"start":{"line":401,"column":62,"offset":12996},"end":{"line":401,"column":72,"offset":13006},"indent":[]}},{"type":"text","value":"分支：","position":{"start":{"line":401,"column":72,"offset":13006},"end":{"line":401,"column":75,"offset":13009},"indent":[]}}],"position":{"start":{"line":401,"column":1,"offset":12935},"end":{"line":401,"column":75,"offset":13009},"indent":[]}},{"type":"html","lang":"javascript","value":"<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">updateHostEffects</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>primaryEffectTag<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">case</span> Placement<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span><span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">case</span> PlacementAndUpdate<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span><span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">case</span> Update<span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">var</span> current <span class=\"token operator\">=</span> nextEffect<span class=\"token punctuation\">.</span>alternate<span class=\"token punctuation\">;</span>\n          <span class=\"token function\">commitWork</span><span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">,</span> nextEffect<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">case</span> Deletion<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span><span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","position":{"start":{"line":403,"column":1,"offset":13011},"end":{"line":417,"column":4,"offset":13336},"indent":[1,1,1,1,1,1,1,1,1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"​\t继续执行","position":{"start":{"line":421,"column":1,"offset":13340},"end":{"line":421,"column":7,"offset":13346},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"commitWork","position":{"start":{"line":421,"column":9,"offset":13348},"end":{"line":421,"column":19,"offset":13358},"indent":[]}}],"position":{"start":{"line":421,"column":7,"offset":13346},"end":{"line":421,"column":21,"offset":13360},"indent":[]}},{"type":"text","value":"，react会执行","position":{"start":{"line":421,"column":21,"offset":13360},"end":{"line":421,"column":30,"offset":13369},"indent":[]}},{"type":"link","title":null,"url":"https://github.com/facebook/react/blob/8a8d973d3cc5623676a84f87af66ef9259c3937c/packages/react-dom/src/client/ReactDOMComponent.js#L326","children":[{"type":"strong","children":[{"type":"text","value":"updateDOMProperties","position":{"start":{"line":421,"column":33,"offset":13372},"end":{"line":421,"column":52,"offset":13391},"indent":[]}}],"position":{"start":{"line":421,"column":31,"offset":13370},"end":{"line":421,"column":54,"offset":13393},"indent":[]}}],"position":{"start":{"line":421,"column":30,"offset":13369},"end":{"line":421,"column":192,"offset":13531},"indent":[]}},{"type":"text","value":"函数，他将在render阶段添加的updateQueue应用到fiber节点上，并更新","position":{"start":{"line":421,"column":192,"offset":13531},"end":{"line":421,"column":235,"offset":13574},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"span","position":{"start":{"line":421,"column":237,"offset":13576},"end":{"line":421,"column":241,"offset":13580},"indent":[]}}],"position":{"start":{"line":421,"column":235,"offset":13574},"end":{"line":421,"column":243,"offset":13582},"indent":[]}},{"type":"text","value":"元素的","position":{"start":{"line":421,"column":243,"offset":13582},"end":{"line":421,"column":246,"offset":13585},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"textContent","position":{"start":{"line":421,"column":248,"offset":13587},"end":{"line":421,"column":259,"offset":13598},"indent":[]}}],"position":{"start":{"line":421,"column":246,"offset":13585},"end":{"line":421,"column":261,"offset":13600},"indent":[]}},{"type":"text","value":"属性。","position":{"start":{"line":421,"column":261,"offset":13600},"end":{"line":421,"column":264,"offset":13603},"indent":[]}}],"position":{"start":{"line":421,"column":1,"offset":13340},"end":{"line":421,"column":264,"offset":13603},"indent":[]}},{"type":"html","lang":"javascript","value":"<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">updateDOMProperties</span><span class=\"token punctuation\">(</span>domElement<span class=\"token punctuation\">,</span> updatePayload<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> updatePayload<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i <span class=\"token operator\">+=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> propKey <span class=\"token operator\">=</span> updatePayload<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> propValue <span class=\"token operator\">=</span> updatePayload<span class=\"token punctuation\">[</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>propKey <span class=\"token operator\">===</span> <span class=\"token constant\">STYLE</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">}</span> \n    <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>propKey <span class=\"token operator\">===</span> <span class=\"token constant\">DANGEROUSLY_SET_INNER_HTML</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span><span class=\"token punctuation\">}</span> \n    <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>propKey <span class=\"token operator\">===</span> <span class=\"token constant\">CHILDREN</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">setTextContent</span><span class=\"token punctuation\">(</span>domElement<span class=\"token punctuation\">,</span> propValue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span><span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","position":{"start":{"line":423,"column":1,"offset":13605},"end":{"line":435,"column":4,"offset":14021},"indent":[1,1,1,1,1,1,1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"​\t当DOM更新被执行后，react将","position":{"start":{"line":437,"column":1,"offset":14023},"end":{"line":437,"column":20,"offset":14042},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"finishedWork","position":{"start":{"line":437,"column":22,"offset":14044},"end":{"line":437,"column":34,"offset":14056},"indent":[]}}],"position":{"start":{"line":437,"column":20,"offset":14042},"end":{"line":437,"column":36,"offset":14058},"indent":[]}},{"type":"text","value":"树分配到","position":{"start":{"line":437,"column":36,"offset":14058},"end":{"line":437,"column":40,"offset":14062},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"HostRoot","position":{"start":{"line":437,"column":42,"offset":14064},"end":{"line":437,"column":50,"offset":14072},"indent":[]}}],"position":{"start":{"line":437,"column":40,"offset":14062},"end":{"line":437,"column":52,"offset":14074},"indent":[]}},{"type":"text","value":"：","position":{"start":{"line":437,"column":52,"offset":14074},"end":{"line":437,"column":53,"offset":14075},"indent":[]}}],"position":{"start":{"line":437,"column":1,"offset":14023},"end":{"line":437,"column":53,"offset":14075},"indent":[]}},{"type":"html","lang":"javascript","value":"<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">root<span class=\"token punctuation\">.</span>current <span class=\"token operator\">=</span> finishedWork<span class=\"token punctuation\">;</span></code></pre></div>","position":{"start":{"line":439,"column":1,"offset":14077},"end":{"line":441,"column":4,"offset":14123},"indent":[1,1]}},{"type":"heading","depth":3,"children":[{"type":"text","value":"Calling post mutation lifecycle hooks","position":{"start":{"line":445,"column":5,"offset":14131},"end":{"line":445,"column":42,"offset":14168},"indent":[]}}],"position":{"start":{"line":445,"column":1,"offset":14127},"end":{"line":445,"column":42,"offset":14168},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"​\t剩下的最后一个函数是","position":{"start":{"line":447,"column":1,"offset":14170},"end":{"line":447,"column":13,"offset":14182},"indent":[]}},{"type":"link","title":null,"url":"https://github.com/facebook/react/blob/d5e1bf07d086e4fc1998653331adecddcd0f5274/packages/react-reconciler/src/ReactFiberScheduler.js#L479","children":[{"type":"strong","children":[{"type":"text","value":"commitAllLifecycles","position":{"start":{"line":447,"column":16,"offset":14185},"end":{"line":447,"column":35,"offset":14204},"indent":[]}}],"position":{"start":{"line":447,"column":14,"offset":14183},"end":{"line":447,"column":37,"offset":14206},"indent":[]}}],"position":{"start":{"line":447,"column":13,"offset":14182},"end":{"line":447,"column":177,"offset":14346},"indent":[]}},{"type":"text","value":"。在这里react会调用更新后的生命周期。在render阶段中，react添加","position":{"start":{"line":447,"column":177,"offset":14346},"end":{"line":447,"column":216,"offset":14385},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"Update","position":{"start":{"line":447,"column":218,"offset":14387},"end":{"line":447,"column":224,"offset":14393},"indent":[]}}],"position":{"start":{"line":447,"column":216,"offset":14385},"end":{"line":447,"column":226,"offset":14395},"indent":[]}},{"type":"text","value":" effect到","position":{"start":{"line":447,"column":226,"offset":14395},"end":{"line":447,"column":234,"offset":14403},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"ClickCounter","position":{"start":{"line":447,"column":236,"offset":14405},"end":{"line":447,"column":248,"offset":14417},"indent":[]}}],"position":{"start":{"line":447,"column":234,"offset":14403},"end":{"line":447,"column":250,"offset":14419},"indent":[]}},{"type":"text","value":"组件中。这是","position":{"start":{"line":447,"column":250,"offset":14419},"end":{"line":447,"column":256,"offset":14425},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"commitAllLifecycles","position":{"start":{"line":447,"column":258,"offset":14427},"end":{"line":447,"column":277,"offset":14446},"indent":[]}}],"position":{"start":{"line":447,"column":256,"offset":14425},"end":{"line":447,"column":279,"offset":14448},"indent":[]}},{"type":"text","value":"查找并调用的其中一个周期。","position":{"start":{"line":447,"column":279,"offset":14448},"end":{"line":447,"column":292,"offset":14461},"indent":[]}}],"position":{"start":{"line":447,"column":1,"offset":14170},"end":{"line":447,"column":292,"offset":14461},"indent":[]}},{"type":"html","lang":"javascript","value":"<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">commitAllLifeCycles</span><span class=\"token punctuation\">(</span>finishedRoot<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>nextEffect <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> effectTag <span class=\"token operator\">=</span> nextEffect<span class=\"token punctuation\">.</span>effectTag<span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>effectTag <span class=\"token operator\">&amp;</span> <span class=\"token punctuation\">(</span>Update <span class=\"token operator\">|</span> Callback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">const</span> current <span class=\"token operator\">=</span> nextEffect<span class=\"token punctuation\">.</span>alternate<span class=\"token punctuation\">;</span>\n            <span class=\"token function\">commitLifeCycles</span><span class=\"token punctuation\">(</span>finishedRoot<span class=\"token punctuation\">,</span> current<span class=\"token punctuation\">,</span> nextEffect<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        \n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>effectTag <span class=\"token operator\">&amp;</span> Ref<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">commitAttachRef</span><span class=\"token punctuation\">(</span>nextEffect<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        \n        nextEffect <span class=\"token operator\">=</span> nextEffect<span class=\"token punctuation\">.</span>nextEffect<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","position":{"start":{"line":449,"column":1,"offset":14463},"end":{"line":466,"column":4,"offset":14942},"indent":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"​\t在这个函数中，react也会调用第一次被渲染的组件的","position":{"start":{"line":468,"column":1,"offset":14944},"end":{"line":468,"column":29,"offset":14972},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"cDM","position":{"start":{"line":468,"column":31,"offset":14974},"end":{"line":468,"column":34,"offset":14977},"indent":[]}}],"position":{"start":{"line":468,"column":29,"offset":14972},"end":{"line":468,"column":36,"offset":14979},"indent":[]}}],"position":{"start":{"line":468,"column":1,"offset":14944},"end":{"line":468,"column":36,"offset":14979},"indent":[]}}],"position":{"start":{"line":1,"column":1,"offset":0},"end":{"line":468,"column":36,"offset":14979}}}}