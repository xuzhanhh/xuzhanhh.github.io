{"expireTime":9007200807631129000,"key":"transformer-remark-markdown-ast-473eb5baf5f3c8aed27572f7681c6226-gatsby-remark-imagesgatsby-remark-responsive-iframegatsby-remark-prismjsgatsby-remark-copy-linked-filesgatsby-remark-smartypants-","val":{"type":"root","children":[{"type":"heading","depth":2,"children":[{"type":"text","value":"前言","position":{"start":{"line":2,"column":4,"offset":4},"end":{"line":2,"column":6,"offset":6},"indent":[]}}],"position":{"start":{"line":2,"column":1,"offset":1},"end":{"line":2,"column":6,"offset":6},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"​\t简单说下为什么React选择函数式组件，主要是class组件比较冗余、生命周期函数写法不友好，骚写法多，functional组件更符合React编程思想等等等。更具体的可以拜读dan大神的blog:","position":{"start":{"line":4,"column":1,"offset":8},"end":{"line":4,"column":102,"offset":109},"indent":[]}},{"type":"link","title":null,"url":"https://overreacted.io/how-are-function-components-different-from-classes/","children":[{"type":"text","value":"传送门","position":{"start":{"line":4,"column":103,"offset":110},"end":{"line":4,"column":106,"offset":113},"indent":[]}}],"position":{"start":{"line":4,"column":102,"offset":109},"end":{"line":4,"column":183,"offset":190},"indent":[]}},{"type":"text","value":"。其中","position":{"start":{"line":4,"column":183,"offset":190},"end":{"line":4,"column":186,"offset":193},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"Function components capture the rendered values","position":{"start":{"line":4,"column":188,"offset":195},"end":{"line":4,"column":235,"offset":242},"indent":[]}}],"position":{"start":{"line":4,"column":186,"offset":193},"end":{"line":4,"column":237,"offset":244},"indent":[]}},{"type":"text","value":"这句十分精辟的道出函数式组件的优势。","position":{"start":{"line":4,"column":237,"offset":244},"end":{"line":4,"column":255,"offset":262},"indent":[]}}],"position":{"start":{"line":4,"column":1,"offset":8},"end":{"line":4,"column":255,"offset":262},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"​\t但是在16.8之前react的函数式组件十分羸弱，基本只能作用于纯展示组件，主要因为缺少state和生命周期。本人曾经在hooks出来前负责过纯函数式的react项目，所有状态处理都必须在reducer中进行，所有副作用都在saga中执行，可以说是十分艰辛的经历了。在hooks出来后我在公司的一个小中台项目中使用，落地效果不错，代码量显著减少的同时提升了代码的可读性。因为通过custom hooks可以更好地剥离代码结构，不会像以前类组件那样在cDU等生命周期堆了一大堆逻辑，在命令式代码和声明式代码中有一个良性的边界。","position":{"start":{"line":6,"column":1,"offset":264},"end":{"line":6,"column":265,"offset":528},"indent":[]}}],"position":{"start":{"line":6,"column":1,"offset":264},"end":{"line":6,"column":265,"offset":528},"indent":[]}},{"type":"heading","depth":2,"children":[{"type":"text","value":"useState在React中是怎么实现的","position":{"start":{"line":8,"column":4,"offset":533},"end":{"line":8,"column":25,"offset":554},"indent":[]}}],"position":{"start":{"line":8,"column":1,"offset":530},"end":{"line":8,"column":25,"offset":554},"indent":[]}},{"type":"blockquote","children":[{"type":"paragraph","children":[{"type":"text","value":"Hooks take some getting used to — and especially at the boundary of imperative and declarative code.","position":{"start":{"line":10,"column":3,"offset":558},"end":{"line":10,"column":103,"offset":658},"indent":[]}}],"position":{"start":{"line":10,"column":3,"offset":558},"end":{"line":10,"column":103,"offset":658},"indent":[]}}],"position":{"start":{"line":10,"column":1,"offset":556},"end":{"line":10,"column":103,"offset":658},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"​\t如果对hooks不太了解的可以先看看这篇文章:","position":{"start":{"line":12,"column":1,"offset":660},"end":{"line":12,"column":26,"offset":685},"indent":[]}},{"type":"link","title":null,"url":"https://medium.com/@ryardley/react-hooks-not-magic-just-arrays-cd4f1857236e","children":[{"type":"text","value":"前情提要","position":{"start":{"line":12,"column":27,"offset":686},"end":{"line":12,"column":31,"offset":690},"indent":[]}}],"position":{"start":{"line":12,"column":26,"offset":685},"end":{"line":12,"column":109,"offset":768},"indent":[]}},{"type":"text","value":"，十分简明的介绍了hooks的核心原理，但是我对useEffect，useRef等钩子的实现比较好奇，所以开始啃起了源码，下面我会结合源码介绍useState的原理。useState具体逻辑分成三部分：mountState，dispatch， updateState","position":{"start":{"line":12,"column":109,"offset":768},"end":{"line":12,"column":242,"offset":901},"indent":[]}}],"position":{"start":{"line":12,"column":1,"offset":660},"end":{"line":12,"column":242,"offset":901},"indent":[]}},{"type":"heading","depth":3,"children":[{"type":"text","value":"hook的结构","position":{"start":{"line":14,"column":5,"offset":907},"end":{"line":14,"column":12,"offset":914},"indent":[]}}],"position":{"start":{"line":14,"column":1,"offset":903},"end":{"line":14,"column":12,"offset":914},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"首先的是hooks的结构，hooks是挂载在组件Fiber结点上memoizedState的，关于Fiber结点可以看看我的另一篇：","position":{"start":{"line":16,"column":1,"offset":916},"end":{"line":16,"column":67,"offset":982},"indent":[]}},{"type":"link","title":null,"url":"https://xuzhanhh.com/Inside%20Fiber/","children":[{"type":"text","value":"传送门","position":{"start":{"line":16,"column":68,"offset":983},"end":{"line":16,"column":71,"offset":986},"indent":[]}}],"position":{"start":{"line":16,"column":67,"offset":982},"end":{"line":16,"column":110,"offset":1025},"indent":[]}}],"position":{"start":{"line":16,"column":1,"offset":916},"end":{"line":16,"column":110,"offset":1025},"indent":[]}},{"type":"html","lang":"javascript","value":"<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">//hook的结构</span>\n<span class=\"token keyword\">export</span> type Hook <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  memoizedState<span class=\"token punctuation\">:</span> any<span class=\"token punctuation\">,</span> <span class=\"token comment\">//上一次的state</span>\n  baseState<span class=\"token punctuation\">:</span> any<span class=\"token punctuation\">,</span>  <span class=\"token comment\">//当前state</span>\n  baseUpdate<span class=\"token punctuation\">:</span> Update<span class=\"token operator\">&lt;</span>any<span class=\"token punctuation\">,</span> any<span class=\"token operator\">></span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\">// update func</span>\n  queue<span class=\"token punctuation\">:</span> UpdateQueue<span class=\"token operator\">&lt;</span>any<span class=\"token punctuation\">,</span> any<span class=\"token operator\">></span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\">//用于缓存多次action</span>\n  next<span class=\"token punctuation\">:</span> Hook <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">//链表</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>","position":{"start":{"line":18,"column":1,"offset":1027},"end":{"line":27,"column":4,"offset":1277},"indent":[1,1,1,1,1,1,1,1,1]}},{"type":"heading","depth":3,"children":[{"type":"text","value":"renderWithHooks","position":{"start":{"line":29,"column":5,"offset":1283},"end":{"line":29,"column":20,"offset":1298},"indent":[]}}],"position":{"start":{"line":29,"column":1,"offset":1279},"end":{"line":29,"column":20,"offset":1298},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"在reconciler中处理函数式组件的函数是renderWithHooks，其类型是：","position":{"start":{"line":31,"column":1,"offset":1300},"end":{"line":31,"column":45,"offset":1344},"indent":[]}}],"position":{"start":{"line":31,"column":1,"offset":1300},"end":{"line":31,"column":45,"offset":1344},"indent":[]}},{"type":"html","lang":"javascript","value":"<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token function\">renderWithHooks</span><span class=\"token punctuation\">(</span>\n  current<span class=\"token punctuation\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">//当前的fiber结点</span>\n  workInProgress<span class=\"token punctuation\">:</span> Fiber<span class=\"token punctuation\">,</span> \n  Component<span class=\"token punctuation\">:</span> any<span class=\"token punctuation\">,</span> <span class=\"token comment\">//jsx中用&lt;>调用的函数</span>\n  props<span class=\"token punctuation\">:</span> any<span class=\"token punctuation\">,</span>\n  refOrContext<span class=\"token punctuation\">:</span> any<span class=\"token punctuation\">,</span>\n  nextRenderExpirationTime<span class=\"token punctuation\">:</span> ExpirationTime<span class=\"token punctuation\">,</span> <span class=\"token comment\">//需要在什么时候结束</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> any</code></pre></div>","position":{"start":{"line":33,"column":1,"offset":1346},"end":{"line":42,"column":4,"offset":1575},"indent":[1,1,1,1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"在renderWithHooks，核心流程如下：","position":{"start":{"line":44,"column":1,"offset":1577},"end":{"line":44,"column":25,"offset":1601},"indent":[]}}],"position":{"start":{"line":44,"column":1,"offset":1577},"end":{"line":44,"column":25,"offset":1601},"indent":[]}},{"type":"html","lang":"javascript","value":"<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">//从memoizedState中取出hooks</span>\nnextCurrentHook <span class=\"token operator\">=</span> current <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">?</span> current<span class=\"token punctuation\">.</span>memoizedState <span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span> \n<span class=\"token comment\">//判断通过有没有hooks判断是mount还是update，两者的函数不同</span>\nReactCurrentDispatcher<span class=\"token punctuation\">.</span>current <span class=\"token operator\">=</span>\n      nextCurrentHook <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span>\n        <span class=\"token operator\">?</span> HooksDispatcherOnMount\n        <span class=\"token punctuation\">:</span> HooksDispatcherOnUpdate<span class=\"token punctuation\">;</span>\n<span class=\"token comment\">//执行传入的type函数</span>\n<span class=\"token keyword\">let</span> children <span class=\"token operator\">=</span> <span class=\"token function\">Component</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">,</span> refOrContext<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">//执行完函数后的dispatcher变成只能调用context的</span>\nReactCurrentDispatcher<span class=\"token punctuation\">.</span>current <span class=\"token operator\">=</span> ContextOnlyDispatcher<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">return</span> children<span class=\"token punctuation\">;</span></code></pre></div>","position":{"start":{"line":46,"column":1,"offset":1603},"end":{"line":60,"column":4,"offset":2053},"indent":[1,1,1,1,1,1,1,1,1,1,1,1,1,1]}},{"type":"heading","depth":3,"children":[{"type":"text","value":"useState构建时流程","position":{"start":{"line":62,"column":5,"offset":2059},"end":{"line":62,"column":18,"offset":2072},"indent":[]}}],"position":{"start":{"line":62,"column":1,"offset":2055},"end":{"line":62,"column":18,"offset":2072},"indent":[]}},{"type":"heading","depth":4,"children":[{"type":"text","value":"mountState","position":{"start":{"line":64,"column":6,"offset":2079},"end":{"line":64,"column":16,"offset":2089},"indent":[]}}],"position":{"start":{"line":64,"column":1,"offset":2074},"end":{"line":64,"column":16,"offset":2089},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"在HooksDispatcherOnMount中，useState调用的是下面的mountState，作用是创建一个新的hook并使用默认值初始化并绑定其触发器，因为useState底层是useReducer，所以数组第二个值返回的是dispatch。","position":{"start":{"line":66,"column":1,"offset":2091},"end":{"line":66,"column":127,"offset":2217},"indent":[]}}],"position":{"start":{"line":66,"column":1,"offset":2091},"end":{"line":66,"column":127,"offset":2217},"indent":[]}},{"type":"html","lang":"typescript","value":"<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">type</span> BasicStateAction<span class=\"token operator\">&lt;</span><span class=\"token constant\">S</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">S</span> <span class=\"token operator\">=></span> <span class=\"token constant\">S</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|</span> <span class=\"token constant\">S</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> mountState<span class=\"token operator\">&lt;</span><span class=\"token constant\">S</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>\n  initialState<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token constant\">S</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|</span> <span class=\"token constant\">S</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token constant\">S</span><span class=\"token punctuation\">,</span> Dispatch<span class=\"token operator\">&lt;</span>BasicStateAction<span class=\"token operator\">&lt;</span><span class=\"token constant\">S</span><span class=\"token operator\">>></span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> hook <span class=\"token operator\">=</span> <span class=\"token function\">mountWorkInProgressHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">//如果入参是func则会调用，但是不提供参数，带参数的需要包一层</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> initialState <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    initialState <span class=\"token operator\">=</span> <span class=\"token function\">initialState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token comment\">//上一个state和基本(当前)state都初始化</span>\n  hook<span class=\"token punctuation\">.</span>memoizedState <span class=\"token operator\">=</span> hook<span class=\"token punctuation\">.</span>baseState <span class=\"token operator\">=</span> initialState<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> queue <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>hook<span class=\"token punctuation\">.</span>queue <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    last<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    dispatch<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    eagerReducer<span class=\"token punctuation\">:</span> basicStateReducer<span class=\"token punctuation\">,</span> <span class=\"token comment\">// useState使用基础reducer</span>\n    eagerState<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span>initialState<span class=\"token punctuation\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">//返回触发器</span>\n  <span class=\"token keyword\">const</span> dispatch<span class=\"token punctuation\">:</span> Dispatch<span class=\"token operator\">&lt;</span>\n    <span class=\"token comment\">//useState底层是useReducer，所以type是BasicStateAction</span>\n    BasicStateAction<span class=\"token operator\">&lt;</span><span class=\"token constant\">S</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n  <span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>queue<span class=\"token punctuation\">.</span>dispatch <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>dispatchAction<span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span>\n    <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">//绑定当前fiber结点和queue</span>\n    <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>currentlyRenderingFiber<span class=\"token punctuation\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> Fiber<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    queue<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>hook<span class=\"token punctuation\">.</span>memoizedState<span class=\"token punctuation\">,</span> dispatch<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","position":{"start":{"line":68,"column":1,"offset":2219},"end":{"line":99,"column":4,"offset":3088},"indent":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]}},{"type":"heading","depth":4,"children":[{"type":"text","value":"mountWorkInProgressHook","position":{"start":{"line":101,"column":6,"offset":3095},"end":{"line":101,"column":29,"offset":3118},"indent":[]}}],"position":{"start":{"line":101,"column":1,"offset":3090},"end":{"line":101,"column":29,"offset":3118},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"这个函数是mountState时调用的构建hook的方法，在初始化完毕后会连接到当前hook.next（如果有的话）","position":{"start":{"line":103,"column":1,"offset":3120},"end":{"line":103,"column":59,"offset":3178},"indent":[]}}],"position":{"start":{"line":103,"column":1,"offset":3120},"end":{"line":103,"column":59,"offset":3178},"indent":[]}},{"type":"html","lang":"javascript","value":"<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">mountWorkInProgressHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> Hook <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> hook<span class=\"token punctuation\">:</span> Hook <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    memoizedState<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    baseState<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    queue<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    baseUpdate<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    next<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>workInProgressHook <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 列表中的第一个hook</span>\n    firstWorkInProgressHook <span class=\"token operator\">=</span> workInProgressHook <span class=\"token operator\">=</span> hook<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 添加到列表的末尾</span>\n    workInProgressHook <span class=\"token operator\">=</span> workInProgressHook<span class=\"token punctuation\">.</span>next <span class=\"token operator\">=</span> hook<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> workInProgressHook<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","position":{"start":{"line":105,"column":1,"offset":3180},"end":{"line":123,"column":4,"offset":3601},"indent":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]}},{"type":"heading","depth":3,"children":[{"type":"text","value":"dispatch分发函数","position":{"start":{"line":125,"column":5,"offset":3607},"end":{"line":125,"column":17,"offset":3619},"indent":[]}}],"position":{"start":{"line":125,"column":1,"offset":3603},"end":{"line":125,"column":17,"offset":3619},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"​\t在上面我们提到，useState底层是useReducer，所以返回的第二个参数是dispatch函数，其中的设计十分巧妙。","position":{"start":{"line":127,"column":1,"offset":3621},"end":{"line":127,"column":65,"offset":3685},"indent":[]}}],"position":{"start":{"line":127,"column":1,"offset":3621},"end":{"line":127,"column":65,"offset":3685},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"假设我们有以下代码:","position":{"start":{"line":129,"column":1,"offset":3687},"end":{"line":129,"column":11,"offset":3697},"indent":[]}}],"position":{"start":{"line":129,"column":1,"offset":3687},"end":{"line":129,"column":11,"offset":3697},"indent":[]}},{"type":"html","lang":"javascript","value":"<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>data<span class=\"token punctuation\">,</span> setData<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> React<span class=\"token punctuation\">.</span><span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n<span class=\"token function\">setData</span><span class=\"token punctuation\">(</span><span class=\"token string\">'first'</span><span class=\"token punctuation\">)</span>\n<span class=\"token function\">setData</span><span class=\"token punctuation\">(</span><span class=\"token string\">'second'</span><span class=\"token punctuation\">)</span>\n<span class=\"token function\">setData</span><span class=\"token punctuation\">(</span><span class=\"token string\">'third'</span><span class=\"token punctuation\">)</span></code></pre></div>","position":{"start":{"line":131,"column":1,"offset":3699},"end":{"line":136,"column":4,"offset":3810},"indent":[1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"image","title":null,"url":"./pages/image-20190317151730512.png","alt":"image-20190317151730512","position":{"start":{"line":138,"column":1,"offset":3812},"end":{"line":138,"column":64,"offset":3875},"indent":[]}}],"position":{"start":{"line":138,"column":1,"offset":3812},"end":{"line":138,"column":64,"offset":3875},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"在第一次setData后， hooks的结构如上图","position":{"start":{"line":140,"column":1,"offset":3877},"end":{"line":140,"column":26,"offset":3902},"indent":[]}}],"position":{"start":{"line":140,"column":1,"offset":3877},"end":{"line":140,"column":26,"offset":3902},"indent":[]}},{"type":"paragraph","children":[{"type":"image","title":null,"url":"./pages/image-20190317152006773.png","alt":"image-20190317152006773","position":{"start":{"line":142,"column":1,"offset":3904},"end":{"line":142,"column":64,"offset":3967},"indent":[]}}],"position":{"start":{"line":142,"column":1,"offset":3904},"end":{"line":142,"column":64,"offset":3967},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"在第二次setData后， hooks的结构如上图","position":{"start":{"line":144,"column":1,"offset":3969},"end":{"line":144,"column":26,"offset":3994},"indent":[]}}],"position":{"start":{"line":144,"column":1,"offset":3969},"end":{"line":144,"column":26,"offset":3994},"indent":[]}},{"type":"paragraph","children":[{"type":"image","title":null,"url":"./pages/image-20190317152401946.png","alt":"image-20190317152401946","position":{"start":{"line":146,"column":1,"offset":3996},"end":{"line":146,"column":64,"offset":4059},"indent":[]}}],"position":{"start":{"line":146,"column":1,"offset":3996},"end":{"line":146,"column":64,"offset":4059},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"在第三次setData后， hooks的结构如上图","position":{"start":{"line":148,"column":1,"offset":4061},"end":{"line":148,"column":26,"offset":4086},"indent":[]}}],"position":{"start":{"line":148,"column":1,"offset":4061},"end":{"line":148,"column":26,"offset":4086},"indent":[]}},{"type":"paragraph","children":[{"type":"image","title":null,"url":"./pages/image-20190318114449227.png","alt":"image-20190318114449227","position":{"start":{"line":150,"column":1,"offset":4088},"end":{"line":150,"column":64,"offset":4151},"indent":[]}}],"position":{"start":{"line":150,"column":1,"offset":4088},"end":{"line":150,"column":64,"offset":4151},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"在正常情况下，是不会在dispatcher中触发reducer而是将action存入update中在updateState中再执行，但是如果在react没有重渲染需求的前提下是会提前计算state即eagerState。作为性能优化的一环。","position":{"start":{"line":152,"column":1,"offset":4153},"end":{"line":152,"column":121,"offset":4273},"indent":[]}}],"position":{"start":{"line":152,"column":1,"offset":4153},"end":{"line":152,"column":121,"offset":4273},"indent":[]}},{"type":"html","lang":"typescript","value":"<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">function</span> dispatchAction<span class=\"token operator\">&lt;</span><span class=\"token constant\">S</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">A</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>\n  fiber<span class=\"token punctuation\">:</span> Fiber<span class=\"token punctuation\">,</span>\n  queue<span class=\"token punctuation\">:</span> UpdateQueue<span class=\"token operator\">&lt;</span><span class=\"token constant\">S</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">A</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n  action<span class=\"token punctuation\">:</span> <span class=\"token constant\">A</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> alternate <span class=\"token operator\">=</span> fiber<span class=\"token punctuation\">.</span>alternate<span class=\"token punctuation\">;</span>\n   <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">flushPassiveEffects</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token comment\">//获取当前时间并计算可用时间</span>\n    <span class=\"token keyword\">const</span> currentTime <span class=\"token operator\">=</span> <span class=\"token function\">requestCurrentTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> expirationTime <span class=\"token operator\">=</span> <span class=\"token function\">computeExpirationForFiber</span><span class=\"token punctuation\">(</span>currentTime<span class=\"token punctuation\">,</span> fiber<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> update<span class=\"token punctuation\">:</span> Update<span class=\"token operator\">&lt;</span><span class=\"token constant\">S</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">A</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n      expirationTime<span class=\"token punctuation\">,</span>\n      action<span class=\"token punctuation\">,</span>\n      eagerReducer<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n      eagerState<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n      next<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token comment\">//下面的代码就是为了构建queue.last是最新的更新，然后last.next开始是每一次的action</span>\n    <span class=\"token comment\">// 取出last</span>\n    <span class=\"token keyword\">const</span> last <span class=\"token operator\">=</span> queue<span class=\"token punctuation\">.</span>last<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>last <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 自圆</span>\n      update<span class=\"token punctuation\">.</span>next <span class=\"token operator\">=</span> update<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> first <span class=\"token operator\">=</span> last<span class=\"token punctuation\">.</span>next<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>first <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        \n        update<span class=\"token punctuation\">.</span>next <span class=\"token operator\">=</span> first<span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      last<span class=\"token punctuation\">.</span>next <span class=\"token operator\">=</span> update<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    queue<span class=\"token punctuation\">.</span>last <span class=\"token operator\">=</span> update<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n      fiber<span class=\"token punctuation\">.</span>expirationTime <span class=\"token operator\">===</span> NoWork <span class=\"token operator\">&amp;&amp;</span>\n      <span class=\"token punctuation\">(</span>alternate <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">||</span> alternate<span class=\"token punctuation\">.</span>expirationTime <span class=\"token operator\">===</span> NoWork<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 当前队列为空，我们可以在进入render阶段前提前计算出下一个状态。如果新的状态和当前状态相同，则可以退出重渲染</span>\n      <span class=\"token keyword\">const</span> lastRenderedReducer <span class=\"token operator\">=</span> queue<span class=\"token punctuation\">.</span>lastRenderedReducer<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 上次更新完后的reducer</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>lastRenderedReducer <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> prevDispatcher<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>__DEV__<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          prevDispatcher <span class=\"token operator\">=</span> ReactCurrentDispatcher<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 暂存dispatcher</span>\n          ReactCurrentDispatcher<span class=\"token punctuation\">.</span>current <span class=\"token operator\">=</span> InvalidNestedHooksDispatcherOnUpdateInDEV<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">const</span> currentState<span class=\"token punctuation\">:</span> <span class=\"token constant\">S</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>queue<span class=\"token punctuation\">.</span>lastRenderedState<span class=\"token punctuation\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token comment\">// 计算下次state</span>\n          <span class=\"token keyword\">const</span> eagerState <span class=\"token operator\">=</span> <span class=\"token function\">lastRenderedReducer</span><span class=\"token punctuation\">(</span>currentState<span class=\"token punctuation\">,</span> action<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token comment\">// 在update对象中存储预计算的完整状态和reducer，如果在进入render阶段前reducer没有变化那么可以服用eagerState而不用重新再次调用reducer</span>\n          update<span class=\"token punctuation\">.</span>eagerReducer <span class=\"token operator\">=</span> lastRenderedReducer<span class=\"token punctuation\">;</span>\n          update<span class=\"token punctuation\">.</span>eagerState <span class=\"token operator\">=</span> eagerState<span class=\"token punctuation\">;</span>\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">is</span><span class=\"token punctuation\">(</span>eagerState<span class=\"token punctuation\">,</span> currentState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// 在后续的时间中，如果这个组件因别的原因被重渲染且在那时reducer更变后，仍有可能重建这次更新</span>\n            <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token comment\">// Suppress the error. It will throw again in the render phase.</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>__DEV__<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            ReactCurrentDispatcher<span class=\"token punctuation\">.</span>current <span class=\"token operator\">=</span> prevDispatcher<span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">scheduleWork</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">,</span> expirationTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","position":{"start":{"line":154,"column":1,"offset":4275},"end":{"line":225,"column":4,"offset":6412},"indent":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]}},{"type":"heading","depth":3,"children":[{"type":"text","value":"useState更新时流程","position":{"start":{"line":229,"column":5,"offset":6420},"end":{"line":229,"column":18,"offset":6433},"indent":[]}}],"position":{"start":{"line":229,"column":1,"offset":6416},"end":{"line":229,"column":18,"offset":6433},"indent":[]}},{"type":"heading","depth":4,"children":[{"type":"text","value":"updateReducer","position":{"start":{"line":231,"column":6,"offset":6440},"end":{"line":231,"column":19,"offset":6453},"indent":[]}}],"position":{"start":{"line":231,"column":1,"offset":6435},"end":{"line":231,"column":19,"offset":6453},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"​\t因为useState底层是useReducer，所以在更新时的流程(即重渲染组件后)是调用updateReducer的。","position":{"start":{"line":233,"column":1,"offset":6455},"end":{"line":233,"column":63,"offset":6517},"indent":[]}}],"position":{"start":{"line":233,"column":1,"offset":6455},"end":{"line":233,"column":63,"offset":6517},"indent":[]}},{"type":"html","lang":"typescript","value":"<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">function</span> updateState<span class=\"token operator\">&lt;</span><span class=\"token constant\">S</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>\n  initialState<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token constant\">S</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|</span> <span class=\"token constant\">S</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token constant\">S</span><span class=\"token punctuation\">,</span> Dispatch<span class=\"token operator\">&lt;</span>BasicStateAction<span class=\"token operator\">&lt;</span><span class=\"token constant\">S</span><span class=\"token operator\">>></span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">updateReducer</span><span class=\"token punctuation\">(</span>basicStateReducer<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>initialState<span class=\"token punctuation\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","position":{"start":{"line":235,"column":1,"offset":6519},"end":{"line":241,"column":4,"offset":6698},"indent":[1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"​\t所以其reducer十分简单","position":{"start":{"line":243,"column":1,"offset":6700},"end":{"line":243,"column":17,"offset":6716},"indent":[]}}],"position":{"start":{"line":243,"column":1,"offset":6700},"end":{"line":243,"column":17,"offset":6716},"indent":[]}},{"type":"html","lang":"typescript","value":"<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">function</span> basicStateReducer<span class=\"token operator\">&lt;</span><span class=\"token constant\">S</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">:</span> <span class=\"token constant\">S</span><span class=\"token punctuation\">,</span> action<span class=\"token punctuation\">:</span> BasicStateAction<span class=\"token operator\">&lt;</span><span class=\"token constant\">S</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token constant\">S</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">typeof</span> action <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span> <span class=\"token operator\">?</span> <span class=\"token function\">action</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">:</span> action<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","position":{"start":{"line":245,"column":1,"offset":6718},"end":{"line":249,"column":4,"offset":6875},"indent":[1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"​\t我们先把复杂情况抛开，跑通updateReducer流程","position":{"start":{"line":251,"column":1,"offset":6877},"end":{"line":251,"column":31,"offset":6907},"indent":[]}}],"position":{"start":{"line":251,"column":1,"offset":6877},"end":{"line":251,"column":31,"offset":6907},"indent":[]}},{"type":"html","lang":"typescript","value":"<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">function</span> updateReducer<span class=\"token operator\">&lt;</span><span class=\"token constant\">S</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">I</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">A</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>\n  reducer<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">S</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">A</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token constant\">S</span><span class=\"token punctuation\">,</span>\n  initialArg<span class=\"token punctuation\">:</span> <span class=\"token constant\">I</span><span class=\"token punctuation\">,</span>\n  init<span class=\"token operator\">?</span><span class=\"token punctuation\">:</span> <span class=\"token constant\">I</span> <span class=\"token operator\">=></span> <span class=\"token constant\">S</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token constant\">S</span><span class=\"token punctuation\">,</span> Dispatch<span class=\"token operator\">&lt;</span><span class=\"token constant\">A</span><span class=\"token operator\">></span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 获取当前hook,queue</span>\n  <span class=\"token keyword\">const</span> hook <span class=\"token operator\">=</span> <span class=\"token function\">updateWorkInProgressHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> queue <span class=\"token operator\">=</span> hook<span class=\"token punctuation\">.</span>queue<span class=\"token punctuation\">;</span>\n\n  queue<span class=\"token punctuation\">.</span>lastRenderedReducer <span class=\"token operator\">=</span> reducer<span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// action队列的最后一个更新</span>\n  <span class=\"token keyword\">const</span> last <span class=\"token operator\">=</span> queue<span class=\"token punctuation\">.</span>last<span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// 最后一个更新是基本状态</span>\n  <span class=\"token keyword\">const</span> baseUpdate <span class=\"token operator\">=</span> hook<span class=\"token punctuation\">.</span>baseUpdate<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> baseState <span class=\"token operator\">=</span> hook<span class=\"token punctuation\">.</span>baseState<span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// 找到第一个没处理的更新</span>\n  <span class=\"token keyword\">let</span> first<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>baseUpdate <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>last <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 第一次更新时，队列是一个自圆queue.last.next = queue.first。当第一次update提交后，baseUpdate不再为空即可跳出队列</span>\n      last<span class=\"token punctuation\">.</span>next <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    first <span class=\"token operator\">=</span> baseUpdate<span class=\"token punctuation\">.</span>next<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    first <span class=\"token operator\">=</span> last <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">?</span> last<span class=\"token punctuation\">.</span>next <span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>first <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> newState <span class=\"token operator\">=</span> baseState<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> newBaseState <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> newBaseUpdate <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> prevUpdate <span class=\"token operator\">=</span> baseUpdate<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> update <span class=\"token operator\">=</span> first<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> didSkip <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">do</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> updateExpirationTime <span class=\"token operator\">=</span> update<span class=\"token punctuation\">.</span>expirationTime<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>updateExpirationTime <span class=\"token operator\">&lt;</span> renderExpirationTime<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 优先级不足，跳过这次更新，如果这是第一次跳过更新，上一个update/state是newBaseupdate/state</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>didSkip<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          didSkip <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n          newBaseUpdate <span class=\"token operator\">=</span> prevUpdate<span class=\"token punctuation\">;</span>\n          newBaseState <span class=\"token operator\">=</span> newState<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token comment\">// 更新优先级</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>updateExpirationTime <span class=\"token operator\">></span> remainingExpirationTime<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          remainingExpirationTime <span class=\"token operator\">=</span> updateExpirationTime<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 处理更新</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>update<span class=\"token punctuation\">.</span>eagerReducer <span class=\"token operator\">===</span> reducer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token comment\">// 如果更新被提前处理了且reducer跟当前reducer匹配，可以复用eagerState</span>\n          newState <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>update<span class=\"token punctuation\">.</span>eagerState<span class=\"token punctuation\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token constant\">S</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token comment\">// 循环调用reducer</span>\n          <span class=\"token keyword\">const</span> action <span class=\"token operator\">=</span> update<span class=\"token punctuation\">.</span>action<span class=\"token punctuation\">;</span>\n          newState <span class=\"token operator\">=</span> <span class=\"token function\">reducer</span><span class=\"token punctuation\">(</span>newState<span class=\"token punctuation\">,</span> action<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n      prevUpdate <span class=\"token operator\">=</span> update<span class=\"token punctuation\">;</span>\n      update <span class=\"token operator\">=</span> update<span class=\"token punctuation\">.</span>next<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>update <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> update <span class=\"token operator\">!==</span> first<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>didSkip<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      newBaseUpdate <span class=\"token operator\">=</span> prevUpdate<span class=\"token punctuation\">;</span>\n      newBaseState <span class=\"token operator\">=</span> newState<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// 只有在前后state变了才会标记</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">is</span><span class=\"token punctuation\">(</span>newState<span class=\"token punctuation\">,</span> hook<span class=\"token punctuation\">.</span>memoizedState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">markWorkInProgressReceivedUpdate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    hook<span class=\"token punctuation\">.</span>memoizedState <span class=\"token operator\">=</span> newState<span class=\"token punctuation\">;</span>\n    hook<span class=\"token punctuation\">.</span>baseUpdate <span class=\"token operator\">=</span> newBaseUpdate<span class=\"token punctuation\">;</span>\n    hook<span class=\"token punctuation\">.</span>baseState <span class=\"token operator\">=</span> newBaseState<span class=\"token punctuation\">;</span>\n    queue<span class=\"token punctuation\">.</span>lastRenderedState <span class=\"token operator\">=</span> newState<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> dispatch<span class=\"token punctuation\">:</span> Dispatch<span class=\"token operator\">&lt;</span><span class=\"token constant\">A</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>queue<span class=\"token punctuation\">.</span>dispatch<span class=\"token punctuation\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>hook<span class=\"token punctuation\">.</span>memoizedState<span class=\"token punctuation\">,</span> dispatch<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","position":{"start":{"line":253,"column":1,"offset":6909},"end":{"line":335,"column":4,"offset":9177},"indent":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]}},{"type":"html","lang":"javascript","value":"<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">markWorkInProgressReceivedUpdate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  didReceiveUpdate <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","position":{"start":{"line":339,"column":1,"offset":9181},"end":{"line":343,"column":4,"offset":9280},"indent":[1,1,1,1]}},{"type":"heading","depth":2,"children":[{"type":"text","value":"后记","position":{"start":{"line":347,"column":4,"offset":9287},"end":{"line":347,"column":6,"offset":9289},"indent":[]}}],"position":{"start":{"line":347,"column":1,"offset":9284},"end":{"line":347,"column":6,"offset":9289},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"​\t作为系列的第一篇文章，我选择了最常用的hooks开始，抛开提前计算及与react-reconciler的互动，整个流程是十分清晰易懂的。mount的时候构建钩子，触发dispatch时按序插入update。updateState的时候再按序触发reducer。可以说就是一个简单的redux。但是作为系列的开篇我认为知识量已经达到要求了xd","position":{"start":{"line":349,"column":1,"offset":9291},"end":{"line":349,"column":173,"offset":9463},"indent":[]}}],"position":{"start":{"line":349,"column":1,"offset":9291},"end":{"line":349,"column":173,"offset":9463},"indent":[]}}],"position":{"start":{"line":1,"column":1,"offset":0},"end":{"line":349,"column":173,"offset":9463}}}}