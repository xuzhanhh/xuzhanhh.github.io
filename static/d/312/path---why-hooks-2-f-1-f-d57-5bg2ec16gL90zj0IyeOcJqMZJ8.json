{"data":{"site":{"siteMetadata":{"title":"é…±é¦™å‹çŒ«ç ‚ç›†","author":"xuzhanhh"}},"markdownRemark":{"id":"026f8e13-d279-5222-9b1f-874cf9eb0fd2","html":"<blockquote>\n<p>TODOï¼š æ·»åŠ å®é™…è¿è¡Œæ—¶çš„ç»“æ„ç­‰</p>\n</blockquote>\n<h2>å‰è¨€</h2>\n<p>â€‹\t\tåœ¨<a href=\"https://xuzhanhh.com/why%20hooks/\">ä¸Šä¸€ç¯‡æ–‡ç« </a>ä¸­ï¼Œæˆ‘ä»¬æ¢³ç†äº†useStateçš„å®ç°é€»è¾‘ï¼Œå¾—å‡ºæ˜¯å¦‚æœä¸è€ƒè™‘é¢å¤–çš„ä¼˜åŒ–é€»è¾‘ï¼ŒuseStateä¸fiberèŠ‚ç‚¹å”¯ä¸€çš„è”ç³»å°±æ˜¯hooksé˜Ÿåˆ—æ˜¯æŒ‚åœ¨fiberä¸Šçš„memoizedStateï¼Œå½“Reactæ‰§è¡Œåˆ°å½“å‰å‡½æ•°å¼ç»„ä»¶æ—¶ä¼šå°†å…¶æŒ‰åºå–å‡ºå¹¶æ›´æ–°ã€‚é‚£ä¹ˆè¿™ä¸€æ¬¡æˆ‘ä»¬æ¥åˆ°äº†useEffectï¼Œè¿™æ¬¡çš„hookæ˜¯ä¸react-reconcileræœ‰å¾ˆå¼ºçš„è”ç³»çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªhooksæ‰“å¼€react-reconcilerçš„å¤§é—¨ã€‚</p>\n<p>è¿™æ¬¡æˆ‘ä»¬è¦è§‚å¯Ÿçš„ç»„ä»¶æ˜¯ğŸ‘‡ä»‹ä¸ªï¼Œæµç¨‹æ˜¯å½“ç‚¹å‡»äº‹ä»¶è§¦å‘å(Reactè§¦å‘ç»„ä»¶æ›´æ–°)ï¼Œæ§åˆ¶å°logä¹‹å‰Reactåˆ°åº•å¹²äº†ä»€ä¹ˆã€‚</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">App2</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>data<span class=\"token punctuation\">,</span> setData<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> React<span class=\"token punctuation\">.</span><span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n    React<span class=\"token punctuation\">.</span><span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">=></span><span class=\"token punctuation\">{</span>\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'trigger effect'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&lt;</span>div onClick<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">=></span><span class=\"token punctuation\">{</span><span class=\"token function\">setData</span><span class=\"token punctuation\">(</span>data<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token operator\">></span><span class=\"token punctuation\">{</span>data<span class=\"token punctuation\">}</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>mountEffect &#x26; mountLayoutEffect</h2>\n<p>åŒæ ·åœ°ï¼Œæ ¹æ®è§¦å‘æ—¶é—´ä¸åŒuseEffectä¹Ÿåˆ†ä¸ºä¸¤ä¸ªfunc-mountEffectå’ŒupdateEffect</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">function</span> <span class=\"token function\">mountEffect</span><span class=\"token punctuation\">(</span>\n  create<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">void</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\">//å‰¯ä½œç”¨func</span>\n  deps<span class=\"token punctuation\">:</span> <span class=\"token builtin\">Array</span><span class=\"token operator\">&lt;</span>mixed<span class=\"token operator\">></span> <span class=\"token operator\">|</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\">//è®°å¿†åŒ– ç”¨äºä»€ä¹ˆæ—¶å€™è§¦å‘</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">mountEffectImpl</span><span class=\"token punctuation\">(</span>\n    UpdateEffect <span class=\"token operator\">|</span> PassiveEffect<span class=\"token punctuation\">,</span> <span class=\"token comment\">// fiberEffectTag</span>\n    UnmountPassive <span class=\"token operator\">|</span> MountPassive<span class=\"token punctuation\">,</span> <span class=\"token comment\">// hookEffectTag</span>\n    create<span class=\"token punctuation\">,</span>\n    deps<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">mountLayoutEffect</span><span class=\"token punctuation\">(</span>\n  create<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">void</span><span class=\"token punctuation\">,</span>\n  deps<span class=\"token punctuation\">:</span> <span class=\"token builtin\">Array</span><span class=\"token operator\">&lt;</span>mixed<span class=\"token operator\">></span> <span class=\"token operator\">|</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">mountEffectImpl</span><span class=\"token punctuation\">(</span>\n    UpdateEffect<span class=\"token punctuation\">,</span>  <span class=\"token comment\">//è¿™é‡Œä¸åŒå“¦ ä¸ä¼ passiveEffect</span>\n    UnmountMutation <span class=\"token operator\">|</span> MountLayout<span class=\"token punctuation\">,</span>\n    create<span class=\"token punctuation\">,</span>\n    deps<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>â€‹\t\té€šè¿‡ä»£ç å¯ä»¥çœ‹åˆ°mountEffectä¸mountLayoutEffectå”¯ä¸€çš„å·®åˆ«å°±æ˜¯ä¼ å…¥çš„fiberEffectTagå’ŒhookEffectTagä¸åŒï¼Œå½“ç„¶ï¼Œè¿™ä¸¤ä¸ªhookå…·ä½“çš„å·®åˆ«å¯ä»¥çœ‹<a href=\"https://reactjs.org/docs/hooks-reference.html#uselayouteffect\">ä¼ é€é—¨</a>ã€‚</p>\n<p>â€‹\tè¿™è¾¹ç®€å•ä»‹ç»ä¸‹<code class=\"language-text\">useEffect</code>è§¦å‘çš„æ—¶æœºæ˜¯React commitå®Œæ¯•åå¼‚æ­¥æ‰§è¡Œï¼Œ<code class=\"language-text\">useLayoutEffect</code>æ˜¯React commitå®Œæ¯•ååŒæ­¥æ‰§è¡Œï¼Œå¦‚æœåœ¨useLayoutEffectä»£ç å¤ªé‡çš„è¯å¯èƒ½ä¼šå¯¼è‡´çº¿ç¨‹é˜»å¡ï¼Œè€ŒuseEffectåˆ™ä¸ä¼šé˜»å¡ï¼Œå› ä¸ºä»–ä¼šåœ¨æµè§ˆå™¨idleæ—¶é—´æ‰§è¡Œã€‚è¿™ç‚¹æˆ‘ä»¬ä¼šåœ¨åé¢çš„ä»£ç ä½“ç°ã€‚</p>\n<p>â€‹\tæˆ‘ä»¬å…ˆæŠ›å¼€useLayoutEffectåªçœ‹useEffectçš„é€»è¾‘ï¼š</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">function</span> <span class=\"token function\">mountEffectImpl</span><span class=\"token punctuation\">(</span>fiberEffectTag<span class=\"token punctuation\">,</span> hookEffectTag<span class=\"token punctuation\">,</span> create<span class=\"token punctuation\">,</span> deps<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> hook <span class=\"token operator\">=</span> <span class=\"token function\">mountWorkInProgressHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> nextDeps <span class=\"token operator\">=</span> deps <span class=\"token operator\">===</span> undefined <span class=\"token operator\">?</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">:</span> deps<span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// åœ¨renderWithHooksä¸­ currentlyRenderingFiber.effectTag|= sideEffectTag ä»˜ç»™å½“å‰fiberèŠ‚ç‚¹</span>\n  sideEffectTag <span class=\"token operator\">|=</span> fiberEffectTag<span class=\"token punctuation\">;</span>   \n  <span class=\"token comment\">// åˆ›å»ºeffect</span>\n  hook<span class=\"token punctuation\">.</span>memoizedState <span class=\"token operator\">=</span> <span class=\"token function\">pushEffect</span><span class=\"token punctuation\">(</span>hookEffectTag<span class=\"token punctuation\">,</span> create<span class=\"token punctuation\">,</span> undefined<span class=\"token punctuation\">,</span> nextDeps<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">type</span> FunctionComponentUpdateQueue <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  lastEffect<span class=\"token punctuation\">:</span> Effect <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">pushEffect</span><span class=\"token punctuation\">(</span>tag<span class=\"token punctuation\">,</span> create<span class=\"token punctuation\">,</span> destroy<span class=\"token punctuation\">,</span> deps<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> effect<span class=\"token punctuation\">:</span> Effect <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    tag<span class=\"token punctuation\">,</span>\n    create<span class=\"token punctuation\">,</span>\n    destroy<span class=\"token punctuation\">,</span>\n    deps<span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">// ä¼¼æ‹Ÿ è‡ªåœ†</span>\n    next<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>componentUpdateQueue <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    componentUpdateQueue <span class=\"token operator\">=</span> <span class=\"token function\">createFunctionComponentUpdateQueue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//è¿™ä¸ªç»“æ„å¾ˆç®€å•çš„ï¼Œçœ‹ä¸Šé¢çš„type</span>\n    componentUpdateQueue<span class=\"token punctuation\">.</span>lastEffect <span class=\"token operator\">=</span> effect<span class=\"token punctuation\">.</span>next <span class=\"token operator\">=</span> effect<span class=\"token punctuation\">;</span> <span class=\"token comment\">// å¦‚æœåªæœ‰ä»–ä¸€ä¸ª è‡ªåœ†</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> lastEffect <span class=\"token operator\">=</span> componentUpdateQueue<span class=\"token punctuation\">.</span>lastEffect<span class=\"token punctuation\">;</span> <span class=\"token comment\">//è¿™é‡Œçš„é€»è¾‘å’ŒuseStateçš„ç›¸åŒå“¦</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>lastEffect <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      componentUpdateQueue<span class=\"token punctuation\">.</span>lastEffect <span class=\"token operator\">=</span> effect<span class=\"token punctuation\">.</span>next <span class=\"token operator\">=</span> effect<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> firstEffect <span class=\"token operator\">=</span> lastEffect<span class=\"token punctuation\">.</span>next<span class=\"token punctuation\">;</span>\n      lastEffect<span class=\"token punctuation\">.</span>next <span class=\"token operator\">=</span> effect<span class=\"token punctuation\">;</span>\n      effect<span class=\"token punctuation\">.</span>next <span class=\"token operator\">=</span> firstEffect<span class=\"token punctuation\">;</span>\n      componentUpdateQueue<span class=\"token punctuation\">.</span>lastEffect <span class=\"token operator\">=</span> effect<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">//åœ¨memoizedStateä¸­ä»…ä½œè®°å½•æ•°æ®ç”¨</span>\n  <span class=\"token keyword\">return</span> effect<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>updateEffect</h2>\n<p>â€‹\tupdateEffectçš„å¤§ä½“é€»è¾‘ä¸mountEffectç›¸åŒï¼Œä¸»è¦æ˜¯æ·»åŠ äº†pushEffectæ—¶ä»prevEffectå–å‡ºäº†destroyå‡½æ•°å¹¶ä¼ å…¥åˆ°pushEffectä¸­ï¼Œä¸”è¿›è¡Œä¾èµ–æ£€æŸ¥ï¼Œå¦‚æœç›¸åŒåˆ™åœ¨hookEffecté€‰æ‹©NoHookEffectï¼Œä¸æ›´æ–°memoizedStateå’Œä¸æ›´æ–°sideEffectTagä¸‰ç‚¹ã€‚</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">// è¿™ä¸ªfuncå’ŒmountEffectæ²¡ä»€ä¹ˆå·®åˆ«</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">updateEffect</span><span class=\"token punctuation\">(</span>\n  create<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">void</span><span class=\"token punctuation\">,</span>\n  deps<span class=\"token punctuation\">:</span> <span class=\"token builtin\">Array</span><span class=\"token operator\">&lt;</span>mixed<span class=\"token operator\">></span> <span class=\"token operator\">|</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">updateEffectImpl</span><span class=\"token punctuation\">(</span>\n    UpdateEffect <span class=\"token operator\">|</span> PassiveEffect<span class=\"token punctuation\">,</span>\n    UnmountPassive <span class=\"token operator\">|</span> MountPassive<span class=\"token punctuation\">,</span>\n    create<span class=\"token punctuation\">,</span>\n    deps<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">function</span> <span class=\"token function\">updateEffectImpl</span><span class=\"token punctuation\">(</span>fiberEffectTag<span class=\"token punctuation\">,</span> hookEffectTag<span class=\"token punctuation\">,</span> create<span class=\"token punctuation\">,</span> deps<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> hook <span class=\"token operator\">=</span> <span class=\"token function\">updateWorkInProgressHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> nextDeps <span class=\"token operator\">=</span> deps <span class=\"token operator\">===</span> undefined <span class=\"token operator\">?</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">:</span> deps<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> destroy <span class=\"token operator\">=</span> undefined<span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// å¦‚æœå½“å‰hookæœ‰æ•°æ®ï¼Œå³æ›´æ–°çŠ¶æ€</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>currentHook <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> prevEffect <span class=\"token operator\">=</span> currentHook<span class=\"token punctuation\">.</span>memoizedState<span class=\"token punctuation\">;</span>\n     <span class=\"token comment\">// ä»ä¸Šä¸€æ¬¡è°ƒç”¨å®ŒsideEffectåçš„è¿”å›å€¼å–å‡ºdestroy</span>\n    destroy <span class=\"token operator\">=</span> prevEffect<span class=\"token punctuation\">.</span>destroy<span class=\"token punctuation\">;</span>\n    \n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nextDeps <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> prevDeps <span class=\"token operator\">=</span> prevEffect<span class=\"token punctuation\">.</span>deps<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">areHookInputsEqual</span><span class=\"token punctuation\">(</span>nextDeps<span class=\"token punctuation\">,</span> prevDeps<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// å¦‚æœä¾èµ–ä¸ä¸ºç©ºä¸”ä¸¤æ¬¡ä¾èµ–æ ¡éªŒç›¸åŒï¼Œåˆ™æ‰§è¡Œä¸Šé¢æ‰€è¯´çš„ä¸‰ç‚¹</span>\n        <span class=\"token function\">pushEffect</span><span class=\"token punctuation\">(</span>NoHookEffect<span class=\"token punctuation\">,</span> create<span class=\"token punctuation\">,</span> destroy<span class=\"token punctuation\">,</span> nextDeps<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  sideEffectTag <span class=\"token operator\">|=</span> fiberEffectTag<span class=\"token punctuation\">;</span>\n  hook<span class=\"token punctuation\">.</span>memoizedState <span class=\"token operator\">=</span> <span class=\"token function\">pushEffect</span><span class=\"token punctuation\">(</span>hookEffectTag<span class=\"token punctuation\">,</span> create<span class=\"token punctuation\">,</span> destroy<span class=\"token punctuation\">,</span> nextDeps<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>è‡³æ­¤ï¼ŒuseEffectåœ¨ReactFiberHooks.jsé‡Œçš„é€»è¾‘å·²ç»æ²¡æœ‰äº†ï¼Œå‰©ä¸‹æˆ‘ä»¬å°†è·‘å…¥react-reconcilerä¸­ã€‚è§‚å¯ŸuseEffectå‰©ä¸‹çš„é€»è¾‘æ˜¯æ€ä¹ˆæ‰§è¡Œçš„ã€‚</p>\n<h2>renderé˜¶æ®µ</h2>\n<p>classç»„ä»¶çš„å…·ä½“æµç¨‹å¯ä»¥çœ‹æˆ‘è¿™ç¯‡<a href=\"https://xuzhanhh.com/Inside%20Fiber/\">blog</a>ï¼Œä¸‹é¢å¼€å§‹åˆ†æfunctionalç»„ä»¶ï¼Œæˆ‘ä¼šå°†è®¾è®¡ä¸€ä¸ªåˆ†ç•Œç‚¹åœ¨updateFunctionComponentï¼Œè¿™æ ·æˆ‘è®¤ä¸ºæµç¨‹çœ‹èµ·æ¥ä¼šæ›´åŠ æ¸…æ™°</p>\n<h3>åœ¨updateFunctionComponentä¹‹å‰</h3>\n<h4>renderRoot &#x26; workloop</h4>\n<p>reconcileé€šå¸¸ä»<code class=\"language-text\">HostRoot</code>fiberç»“ç‚¹ï¼Œå¹¶é€šè¿‡<a href=\"https://github.com/facebook/react/blob/95a313ec0b957f71798a69d8e83408f40e76765b/packages/react-reconciler/src/ReactFiberScheduler.js#L1132\">renderRoot</a>æ–¹æ³•å¼€å§‹ã€‚ä½†æ˜¯ï¼ŒReactä¼šå¿«é€Ÿè·³è¿‡å·²ç»å¤„ç†è¿‡çš„fiberèŠ‚ç‚¹çŸ¥é“ä»–æ‰¾åˆ°ä¸€ä¸ªæœªå®Œæˆå·¥ä½œçš„ç»“ç‚¹ã€‚ä¸¾ä¸ªğŸŒ°ï¼Œå¦‚æœä½ åœ¨ç»„ä»¶æ ‘çš„æ·±å±‚è°ƒç”¨<code class=\"language-text\">setState</code>ï¼ŒReactä»ç„¶ä¼šä»RootèŠ‚ç‚¹å¼€å§‹reconcileä¸è¿‡ä¼šå¿«é€Ÿè·³è¿‡èŠ‚ç‚¹ç›´åˆ°é‡åˆ°è°ƒç”¨setStateçš„ç»„ä»¶ã€‚åœ¨renderRootä¸­ï¼Œæ‰€æœ‰çš„fiberèŠ‚ç‚¹éƒ½ä¼šåœ¨<a href=\"https://github.com/facebook/react/blob/f765f022534958bcf49120bf23bc1aa665e8f651/packages/react-reconciler/src/ReactFiberScheduler.js#L1136\">workloop</a>ä¸­è¢«å¤„ç†ã€‚åœ¨æœ¬ç¯‡blogä¸­ï¼Œæˆ‘ä»¬é»˜è®¤ä½¿ç”¨åŒæ­¥æ¨¡å¼ã€‚</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">workLoop</span><span class=\"token punctuation\">(</span>isYieldy<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>isYieldy<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Flush work without yielding</span>\n    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>nextUnitOfWork <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      nextUnitOfWork <span class=\"token operator\">=</span> <span class=\"token function\">performUnitOfWork</span><span class=\"token punctuation\">(</span>nextUnitOfWork<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">nextUnitOfWork</code>ä¼šä¿ç•™å¯¹<code class=\"language-text\">workInProgress</code>treeä¸­éœ€è¦å¤„ç†çš„fiberèŠ‚ç‚¹çš„å¼•ç”¨ã€‚å½“Reactéå†fiber treeæ—¶ï¼Œä¼šç”¨è¿™ä¸ªå˜é‡å»çŸ¥æ™“è¿™é‡Œæ˜¯å¦æœ‰å…¶ä»–æœªå®Œæˆå·¥ä½œçš„fiberç»“ç‚¹ã€‚</p>\n<p>è¿™é‡Œä¼šæœ‰å››ä¸ªä¸»è¦å‡½æ•°ç”¨äºéå†fiberæ ‘åŠå‘èµ·ã€å®Œæˆå·¥ä½œï¼š</p>\n<ul>\n<li><a href=\"https://github.com/facebook/react/blob/95a313ec0b957f71798a69d8e83408f40e76765b/packages/react-reconciler/src/ReactFiberScheduler.js#L1056\">performUnitOfWork</a></li>\n<li><a href=\"https://github.com/facebook/react/blob/cbbc2b6c4d0d8519145560bd8183ecde55168b12/packages/react-reconciler/src/ReactFiberBeginWork.js#L1489\">beginWork</a></li>\n<li><a href=\"https://github.com/facebook/react/blob/95a313ec0b957f71798a69d8e83408f40e76765b/packages/react-reconciler/src/ReactFiberScheduler.js#L879\">completeUnitOfWork</a></li>\n<li><a href=\"https://github.com/facebook/react/blob/cbbc2b6c4d0d8519145560bd8183ecde55168b12/packages/react-reconciler/src/ReactFiberCompleteWork.js#L532\">completeWork</a></li>\n</ul>\n<p>è®©æˆ‘ä»¬é€šè¿‡ä¸‹é¢è¿™ä¸ªç®€åŒ–äº†çš„gifæ¼”ç¤ºä»–ä»¬æ˜¯æ€ä¹ˆè¿è¡Œçš„ï¼Œæ¯ä¸€ä¸ªå‡½æ•°éœ€è¦ä¸€ä¸ªfiberèŠ‚ç‚¹ä½œä¸ºå…¥å‚ã€‚å½“Reactéå†fiberæ ‘æ—¶å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°å½“å‰fiberèŠ‚ç‚¹çš„å˜åŠ¨ï¼Œåœ¨å¤„ç†çˆ¶äº²èŠ‚ç‚¹å‰ä¼šå…ˆä¼šå®Œæˆå­©å­èŠ‚ç‚¹ã€‚è¿™ä¸ªå›¾åŠ¨çš„å¾ˆå¿«ï¼Œå»ºè®®ä»”ç»†ä¸€æ­¥æ­¥çœ‹ã€‚</p>\n<blockquote>\n<p>åŒä¸€åˆ—æ˜¯å…„å¼ŸèŠ‚ç‚¹ï¼Œå‘å³çš„æ˜¯å­©å­èŠ‚ç‚¹</p>\n</blockquote>\n<p><img src=\"/images/1*A3-yF-3Xf47nPamFpRm64w.png\" alt=\"img\"></p>\n<h4>performUnitOfWork</h4>\n<p><strong>performUnitOfWork</strong>æ¥æ”¶ä¸€ä¸ªä»<strong>workInProgress tree</strong>ä¸­çš„fiberèŠ‚ç‚¹ï¼Œç„¶åè°ƒç”¨<strong>beginWork</strong>ï¼ŒbeginWorkæ˜¯è§¦å‘fiberèŠ‚ç‚¹æ›´æ–°çš„åœ°æ–¹ã€‚</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">performUnitOfWork</span><span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> next <span class=\"token operator\">=</span> <span class=\"token function\">beginWork</span><span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>next <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        next <span class=\"token operator\">=</span> <span class=\"token function\">completeUnitOfWork</span><span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> next<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>beginWork</h4>\n<p>åœ¨beginWorkä¸­ï¼Œä¸»è¦é€»è¾‘åˆ†ä¸ºåˆ¤æ–­è¯¥fiberçš„propså’Œcontextæœ‰å¦å‘ç”Ÿå˜åŒ–ï¼Œå¦‚æœå‘ç”Ÿå˜åŒ–åˆ™æ ‡è®°didReceiveUpdateä¸ºtrueï¼Œä¸”åˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°ï¼Œå¦‚æœæ²¡æœ‰æ›´æ–°åˆ™returnã€‚æ²¡æœ‰returnåˆ™è¿›å…¥æ›´æ–°ç»„ä»¶é˜¶æ®µã€‚</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// è¿™é‡Œåˆ†æå‡½æ•°å¼ç»„ä»¶çš„beginWork, current->å½“å‰æ¸²æŸ“ä½¿ç”¨çš„fiberï¼ŒworkInProgress->è¿™æ¬¡æ›´æ–°ç”¨çš„fiber</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">beginWork</span><span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">,</span> workInProgress<span class=\"token punctuation\">,</span> renderExpirationTime<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> updateExpirationTime <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>expirationTime<span class=\"token punctuation\">;</span> <span class=\"token comment\">// è¿˜å‰©å¤šå°‘æ—¶é—´</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>current <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> oldProps <span class=\"token operator\">=</span> current<span class=\"token punctuation\">.</span>memoizedProps<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> newProps <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>pendingProps<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oldProps <span class=\"token operator\">!==</span> newProps <span class=\"token operator\">||</span> <span class=\"token function\">hasLegacyContextChanged</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">//å¦‚æœpropsæˆ–è€…contextå˜åŒ–ï¼Œåˆ™æ ‡è®°è¯¥fiberèŠ‚ç‚¹åœ¨ä¹‹å‰å·²ç»æ›´æ–°è¿‡</span>\n      <span class=\"token comment\">//åœ¨memoçš„ä¸”memorizeç›¸åŒçš„æƒ…å†µä¸‹ä¸è®¾ç½®</span>\n      didReceiveUpdate <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>updateExpirationTime <span class=\"token operator\">&lt;</span> renderExpirationTime<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      didReceiveUpdate <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n      <span class=\"token comment\">// è¿™ä¸ªfiberèŠ‚ç‚¹æ²¡æ´»å¹²ï¼Œæ‰€ä»¥ç›´æ¥è·³å‡ºå³å¯ï¼Œä½†æ˜¯åœ¨è·³å‡ºå‰è¿˜æœ‰ä¸€äº›ä¼˜åŒ–é€»è¾‘è¦å¤„ç†ï¼Œe.g.å¾€æ ˆä¸Šæ”¾å¿…é¡»çš„æ•°æ®</span>\n      <span class=\"token comment\">// ...è¿™é‡Œæˆ‘ä»¬æš‚æ—¶ä¸å…³å¿ƒ</span>\n      <span class=\"token keyword\">return</span> <span class=\"token function\">bailoutOnAlreadyFinishedWork</span><span class=\"token punctuation\">(</span>\n        current<span class=\"token punctuation\">,</span>\n        workInProgress<span class=\"token punctuation\">,</span>\n        renderExpirationTime<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//å¦‚æœä¸Šä¸€ä¸ªçŠ¶æ€æ²¡æœ‰fiberèŠ‚ç‚¹</span>\n    didReceiveUpdate <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">//æ¸…ç©ºå‘¼æ°”æ—¶é—´</span>\n  workInProgress<span class=\"token punctuation\">.</span>expirationTime <span class=\"token operator\">=</span> NoWork<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">.</span>tag<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> FunctionComponent<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> Component <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">const</span> unresolvedProps <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>pendingProps<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">const</span> resolvedProps <span class=\"token operator\">=</span>\n        workInProgress<span class=\"token punctuation\">.</span>elementType <span class=\"token operator\">===</span> Component\n          <span class=\"token operator\">?</span> unresolvedProps\n          <span class=\"token punctuation\">:</span> <span class=\"token function\">resolveDefaultProps</span><span class=\"token punctuation\">(</span>Component<span class=\"token punctuation\">,</span> unresolvedProps<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">return</span> <span class=\"token function\">updateFunctionComponent</span><span class=\"token punctuation\">(</span>\n        current<span class=\"token punctuation\">,</span>\n        workInProgress<span class=\"token punctuation\">,</span>\n        Component<span class=\"token punctuation\">,</span>\n        resolvedProps<span class=\"token punctuation\">,</span>\n        renderExpirationTime<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> workInProgress<span class=\"token punctuation\">.</span>child<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>updateFunctionComponent</h4>\n<p>â€‹\tåœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼ŒReactä¼šè°ƒç”¨renderWithHookså¾—åˆ°å½“å‰fiberèŠ‚ç‚¹çš„ç»“æœå¹¶è¿”å›è¯¥ç»„ä»¶çš„å­ç»„ä»¶ã€‚å¹¶æ ¹æ®didReceiveUpdateåˆ¤æ–­è¯¥ç»„ä»¶æ ‘(è¯¥ç»„ä»¶åŠå…¶å­ç»„ä»¶)æ˜¯å¦éœ€è¦æ›´æ–°ã€‚å¦‚æœä¸éœ€è¦æ›´æ–°åˆ™åœ¨å®Œæˆè¿˜åŸç­‰æ“ä½œåè·³å‡º(bail out)ï¼Œå¦åˆ™è¿›å…¥å­ç»„ä»¶çš„reconcileæµç¨‹(reconcileChildren)ã€‚</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">function</span> <span class=\"token function\">updateFunctionComponent</span><span class=\"token punctuation\">(</span>\n  current<span class=\"token punctuation\">,</span>\n  workInProgress<span class=\"token punctuation\">,</span>\n  Component<span class=\"token punctuation\">,</span>\n  nextProps<span class=\"token punctuation\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">,</span>\n  renderExpirationTime<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token keyword\">const</span> unmaskedContext <span class=\"token operator\">=</span> <span class=\"token function\">getUnmaskedContext</span><span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">,</span> Component<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> context <span class=\"token operator\">=</span> <span class=\"token function\">getMaskedContext</span><span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">,</span> unmaskedContext<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">let</span> nextChildren<span class=\"token punctuation\">;</span>\n  <span class=\"token function\">prepareToReadContext</span><span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">,</span> renderExpirationTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  nextChildren <span class=\"token operator\">=</span> <span class=\"token function\">renderWithHooks</span><span class=\"token punctuation\">(</span>\n    current<span class=\"token punctuation\">,</span>\n    workInProgress<span class=\"token punctuation\">,</span>\n    Component<span class=\"token punctuation\">,</span>\n    nextProps<span class=\"token punctuation\">,</span>\n    context<span class=\"token punctuation\">,</span>\n    renderExpirationTime<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// å¦‚æœä¸Šä¸€ä¸ªçŠ¶æ€æœ‰fiberèŠ‚ç‚¹ä¸”æ²¡æœ‰æ¥å—åˆ°æ›´æ–° å¦‚æœè°ƒç”¨äº†setStateåˆ™ä¼šåœ¨updateReducerä¸­</span>\n<span class=\"token comment\">// è°ƒç”¨markWorkInProgressReceivedUpdateå°†didReceiveUpdateç½®ä¸ºtrue</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>current <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>didReceiveUpdate<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// å› ä¸ºè¦è·³å‡ºè¿™ä¸ªç»„ä»¶çš„renderé˜¶æ®µï¼Œæ‰€ä»¥æ¸…ç©ºhooksï¼Œé‡ç½®workInProgressä¸­çš„æ•°æ®</span>\n    <span class=\"token function\">bailoutHooks</span><span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">,</span> workInProgress<span class=\"token punctuation\">,</span> renderExpirationTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">bailoutOnAlreadyFinishedWork</span><span class=\"token punctuation\">(</span>\n      current<span class=\"token punctuation\">,</span>\n      workInProgress<span class=\"token punctuation\">,</span>\n      renderExpirationTime<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function\">reconcileChildren</span><span class=\"token punctuation\">(</span>\n    current<span class=\"token punctuation\">,</span>\n    workInProgress<span class=\"token punctuation\">,</span>\n    nextChildren<span class=\"token punctuation\">,</span>\n    renderExpirationTime<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> workInProgress<span class=\"token punctuation\">.</span>child<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>åœ¨updateFunctionComponentä¹‹å</h3>\n<h4>è¯¥ç»„ä»¶ä¸éœ€è¦æ›´æ–°(ä¿®æ”¹&#x26;æ–°å¢)</h4>\n<p>å¦‚æœè¯¥ç»„ä»¶ä¸éœ€è¦æ›´æ–°ï¼Œé‚£ä¹ˆå°±ä¼šæ‰§è¡Œä»¥ä¸‹æ“ä½œåè·³å‡ºï¼š</p>\n<ol>\n<li>æ¸…ç©ºå·²ç»å…¥é˜Ÿçš„æ›´æ–°</li>\n<li>ç§»é™¤PassiveEffectå’ŒUpdateEffect</li>\n<li>ç§»é™¤å‘¼æ°”æ—¶é—´</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">bailoutHooks</span><span class=\"token punctuation\">(</span>\n  current<span class=\"token punctuation\">:</span> Fiber<span class=\"token punctuation\">,</span>\n  workInProgress<span class=\"token punctuation\">:</span> Fiber<span class=\"token punctuation\">,</span>\n  expirationTime<span class=\"token punctuation\">:</span> ExpirationTime<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// å¤ç”¨updateQueue   </span>\n  workInProgress<span class=\"token punctuation\">.</span>updateQueue <span class=\"token operator\">=</span> current<span class=\"token punctuation\">.</span>updateQueue<span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// ç§»é™¤ä¸¤ä¸ªtag</span>\n  workInProgress<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">&amp;=</span> <span class=\"token operator\">~</span><span class=\"token punctuation\">(</span>PassiveEffect <span class=\"token operator\">|</span> UpdateEffect<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">.</span>expirationTime <span class=\"token operator\">&lt;=</span> expirationTime<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//ç§»é™¤å‘¼æ°”æ—¶é—´</span>\n    current<span class=\"token punctuation\">.</span>expirationTime <span class=\"token operator\">=</span> NoWork<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ol start=\"4\">\n<li>å¤ç”¨ä¸Šæ¬¡context</li>\n<li>æ£€æŸ¥å­ç»„ä»¶æ˜¯å¦æœ‰æ›´æ–°ï¼Œå¦‚æœå­ç»„ä»¶æ²¡æœ‰æ›´æ–°ï¼Œåˆ™å¯ä»¥å¯¹è¯¥ç»„ä»¶æ‰§è¡ŒcompleteUnitOfWorkæ“ä½œäº†</li>\n<li>å­ç»„ä»¶æœ‰æ›´æ–°ï¼Œé€šè¿‡current.childé‡æ–°åˆ›å»ºworkInProgress.childå¹¶ä½œä¸ºä¸‹ä¸€ä¸ªè¦å¤„ç†çš„fiberèŠ‚ç‚¹ä¼ å‡º</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">function</span> <span class=\"token function\">bailoutOnAlreadyFinishedWork</span><span class=\"token punctuation\">(</span>\n  current<span class=\"token punctuation\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n  workInProgress<span class=\"token punctuation\">:</span> Fiber<span class=\"token punctuation\">,</span>\n  renderExpirationTime<span class=\"token punctuation\">:</span> ExpirationTime<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">cancelWorkTimer</span><span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>current <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// å¤ç”¨ä¸Šæ¬¡context</span>\n    workInProgress<span class=\"token punctuation\">.</span>contextDependencies <span class=\"token operator\">=</span> current<span class=\"token punctuation\">.</span>contextDependencies<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// æ£€æŸ¥å­ç»„ä»¶æ˜¯å¦æœ‰æ›´æ–°</span>\n  <span class=\"token keyword\">const</span> childExpirationTime <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>childExpirationTime<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>childExpirationTime <span class=\"token operator\">&lt;</span> renderExpirationTime<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// å¦‚æœreturn nullï¼Œè¡¨ç¤ºå­ç»„ä»¶éƒ½æ²¡æ›´æ–° åˆ™å¯ä»¥å¯¹è¯¥ç»„ä»¶æ‰§è¡ŒcompleteUnitOfWorkæ“ä½œäº†</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// è¿™ä¸ªç»„ä»¶æ²¡æœ‰æ›´æ–°ï¼Œä¸è¿‡ä»–çš„å­ç»„ä»¶æœ‰ï¼Œé€šè¿‡current.childé‡æ–°åˆ›å»ºworkInProgress.child</span>\n    <span class=\"token function\">cloneChildFibers</span><span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">,</span> workInProgress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> workInProgress<span class=\"token punctuation\">.</span>child<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>è¯¥ç»„ä»¶éœ€è¦æ›´æ–°(ä¿®æ”¹&#x26;æ–°å¢)</h4>\n<p>â€‹\tå¦‚æœè¯¥ç»„ä»¶éœ€è¦æ›´æ–°ï¼Œé‚£ä¹ˆä¹Ÿè¦å…ˆæ›´æ–°å®Œä»–çš„å­ç»„ä»¶æ‰èƒ½completeè‡ªå·±å‘€ï¼Œè¯¦æƒ…çœ‹ä¸Šé¢ğŸ‘†çš„gifå›¾ã€‚å­ç»„ä»¶æ›´æ–°çš„é€»è¾‘åˆ†ä¸¤ç§ï¼Œæ ¹æ®current=== nullä¸å¦åˆ¤æ–­ï¼Œå…·ä½“é€»è¾‘çœ‹ä»£ç æ³¨é‡Š</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">reconcileChildren</span><span class=\"token punctuation\">(</span>\n  current<span class=\"token punctuation\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n  workInProgress<span class=\"token punctuation\">:</span> Fiber<span class=\"token punctuation\">,</span>\n  nextChildren<span class=\"token punctuation\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">,</span>\n  renderExpirationTime<span class=\"token punctuation\">:</span> ExpirationTime<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>current <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// å¦‚æœè¿™ä¸ªæ˜¯ä¸ªä¹‹å‰æ²¡æ¸²æŸ“è¿‡çš„èˆ¹æ–°ç»„ä»¶ï¼ŒReactä¸ä¼šé€šè¿‡åº”ç”¨æœ€å°å‰¯ä½œç”¨å»æ›´æ–°ä»–çš„å­ç»„ä»¶ï¼Œè€Œæ˜¯åœ¨çˆ¶ç»„ä»¶æ¸²æŸ“å‰å°†å­ç»„ä»¶æ·»åŠ åˆ°çˆ¶ç»„ä»¶ä¸Šã€‚è¿™æ ·Reactå¯ä»¥é€šè¿‡ä¸è·Ÿè¸ªå‰¯ä½œç”¨ä¼˜åŒ–åè°ƒ(reconciliation)è¿‡ç¨‹ã€‚</span>\n    workInProgress<span class=\"token punctuation\">.</span>child <span class=\"token operator\">=</span> <span class=\"token function\">mountChildFibers</span><span class=\"token punctuation\">(</span>\n      workInProgress<span class=\"token punctuation\">,</span>\n      <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n      nextChildren<span class=\"token punctuation\">,</span>\n      renderExpirationTime<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// å¦‚æœå½“å‰(child)å­ç»„ä»¶è·Ÿæ­£åœ¨å¤„ç†(workInProgress)å­ç»„ä»¶ç›¸åŒï¼Œè¿™æ„å‘³ç€Reactè¿˜æ²¡å¼€å§‹å¤„ç†å­ç»„ä»¶ï¼Œå› æ­¤Reactä¼šå¤ç”¨ä¹‹å‰çš„é€»è¾‘å»å¤åˆ¶ä¸€ä»½æ‰€æœ‰å½“å‰(current)å­ç»„ä»¶çš„å®ä¾‹ã€‚å¦‚æœåœ¨è¿™ä¸ªåœ°æ–¹å·²ç»ç”¨å¤„ç†è¿‡çš„updateæ˜¯éæ³•çš„ï¼Œä¸¢æ‰è¿™äº›updat</span>\n    workInProgress<span class=\"token punctuation\">.</span>child <span class=\"token operator\">=</span> <span class=\"token function\">reconcileChildFibers</span><span class=\"token punctuation\">(</span>\n      workInProgress<span class=\"token punctuation\">,</span>\n      current<span class=\"token punctuation\">.</span>child<span class=\"token punctuation\">,</span>\n      nextChildren<span class=\"token punctuation\">,</span>\n      renderExpirationTime<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>completeUnitOfWork</h4>\n<p>â€‹\t<strong>ç”±äºç¯‡å¹…é™åˆ¶ï¼Œè¿™é‡Œæš‚æ—¶ä¸ä»‹ç»Reactæ›´æ–°å­ç»„ä»¶çš„é€»è¾‘ï¼Œè¿™ç‚¹æˆ‘ä»¬æ”¾åˆ°åé¢ä»”ç»†èŠï¼Œæˆ‘ä»¬è¿™æ¬¡å…³æ³¨äºè¿™ä¸ªç»„ä»¶çš„å·¥ä½œæµç¨‹ã€‚</strong> é‚£ä¹ˆæˆ‘ä»¬å‡å®šæ²¡æœ‰å­ç»„ä»¶äº†ï¼ŒReactçŸ¥é“å·²ç»åˆ°è¾¾åˆ†æ”¯çš„ç»“å°¾æ‰€ä»¥ä»–å¯ä»¥å®Œæˆå½“å‰èŠ‚ç‚¹äº†ä¸”å®ŒæˆèŠ‚ç‚¹åReactä¼šå¼€å§‹å…¶å…„å¼ŸèŠ‚ç‚¹çš„å·¥ä½œæˆ–å‘çˆ¶èŠ‚ç‚¹å›æº¯ï¼Œè¿™éƒ¨åˆ†é€»è¾‘æ˜¯completeUnitOfWorkä¸­æ‰§è¡Œã€‚</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">completeUnitOfWork</span><span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> returnFiber <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span><span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> siblingFiber <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>sibling<span class=\"token punctuation\">;</span>\n\n        nextUnitOfWork <span class=\"token operator\">=</span> <span class=\"token function\">completeWork</span><span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>siblingFiber <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// å¦‚æœæœ‰å…„å¼ŸèŠ‚ç‚¹ï¼Œ è¿”å›å…„å¼ŸèŠ‚ç‚¹</span>\n            <span class=\"token keyword\">return</span> siblingFiber<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>returnFiber <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// çˆ¶èŠ‚ç‚¹ä¸‹å·²ç»æ²¡æœ‰éœ€è¦å·¥ä½œçš„èŠ‚ç‚¹äº†ï¼Œè¿”å›çˆ¶èŠ‚ç‚¹</span>\n            workInProgress <span class=\"token operator\">=</span> returnFiber<span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// åˆ°è¾¾æ ¹èŠ‚ç‚¹</span>\n            <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>scheduler</h2>\n<h2>commité˜¶æ®µ</h2>","timeToRead":6,"frontmatter":{"title":"why hooks(2) â€” useEffectæ˜¯æ€ä¹ˆè·‘èµ·æ¥çš„","date":"March 22, 2019","spoiler":"ä»hooksåˆ‡å…¥ï¼Œæ·±å…¥äº†è§£Reactç¼–ç¨‹æ¨¡å‹"},"fields":{"slug":"/why hooks(2)/"}}},"pageContext":{"slug":"/why hooks(2)/","previous":{"fields":{"slug":"/css world(1)/"},"frontmatter":{"title":"ç¥å¥‡çš„CSSä¸–ç•Œ(1)"}},"next":{"fields":{"slug":"/Reactä¸­çš„Scheduler/"},"frontmatter":{"title":"Reactä¸­çš„concurrent mode(1)"}}}}